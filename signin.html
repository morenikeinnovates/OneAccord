<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sign In — OneAccord</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Onest:wght@400;500;600;700;800;900&family=DM+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="shared.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="shared.css">
<style>
body{background:var(--surface);display:flex;flex-direction:column;min-height:100vh}
.signin-wrap{
  flex:1;display:flex;align-items:center;justify-content:center;
  padding:40px 20px;
}
.signin-box{
  background:#fff;border:1.5px solid var(--border);border-radius:24px;
  padding:44px 40px;width:100%;max-width:420px;
  box-shadow:var(--shadow2);animation:fadeUp .4s ease;
}
.signin-logo{
  display:flex;align-items:center;gap:8px;margin-bottom:32px;
  font-family:var(--fd);font-size:18px;font-weight:800;color:var(--ink);
  cursor:pointer;text-decoration:none;
}
.signin-logo-dot{width:9px;height:9px;border-radius:50%;background:var(--lime)}
.signin-h2{font-family:var(--fd);font-size:24px;font-weight:800;letter-spacing:-.5px;margin-bottom:6px}
.signin-sub{font-size:14px;color:var(--muted);line-height:1.6;margin-bottom:28px}

/* OTP inputs */
.otp-row{display:flex;gap:8px;margin-bottom:20px}
.otp-digit{
  flex:1;height:58px;text-align:center;
  font-family:var(--fd);font-size:24px;font-weight:700;
  color:var(--ink);background:var(--surface);
  border:1.5px solid var(--border);border-radius:10px;
  outline:none;transition:border-color .2s;
  -webkit-appearance:none;
}
.otp-digit:focus{border-color:var(--lime);background:#fff}

.email-shown{
  background:var(--lime-bg);border:1px solid var(--lime-border);
  border-radius:8px;padding:10px 14px;
  font-size:14px;font-weight:600;color:#4a6b1a;margin-bottom:20px;
}
.resend-row{font-size:13px;color:var(--muted);text-align:center;margin-top:14px}
.resend-btn{
  background:none;border:none;color:var(--ink);cursor:pointer;
  font-family:var(--fb);font-size:13px;text-decoration:underline;
}
.back-link{
  background:none;border:none;color:var(--muted);cursor:pointer;
  font-family:var(--fb);font-size:13px;margin-top:10px;
  display:block;text-align:center;transition:color .2s;
}
.back-link:hover{color:var(--ink)}
.skip-link{
  text-align:center;margin-top:16px;
  font-size:13px;color:var(--muted);
}
.skip-btn{
  background:none;border:none;color:var(--muted);cursor:pointer;
  font-family:var(--fb);font-size:13px;text-decoration:underline;
}
.skip-btn:hover{color:var(--ink)}

/* Step panels */
.step{display:none}
.step.active{display:block;animation:fadeIn .25s ease}
</style>
</head>
<body>

<!-- NAV -->
<nav class="top-nav">
  <a class="nav-logo" href="index.html"><div class="nav-logo-dot"></div>OneAccord</a>
</nav>

<div class="signin-wrap">
  <div class="signin-box">
    <a class="signin-logo" href="index.html">
      <div class="signin-logo-dot"></div>OneAccord
    </a>

    <!-- Step 1: Email entry -->
    <div class="step active" id="step-email">
      <h2 class="signin-h2" id="auth-heading">Welcome back.</h2>
      <p class="signin-sub" id="auth-subtext">Enter your email — no password needed. We'll send you a 6-digit code.</p>

      <label class="field-label" for="email-input">Email address</label>
      <input
        class="field-input" type="email" id="email-input"
        placeholder="you@example.com" autocomplete="email"
        style="margin-bottom:16px"
        onkeydown="if(event.key==='Enter')sendCode()"
      >
      <div id="email-error" style="display:none;color:#cc4444;font-size:13px;margin-bottom:12px"></div>

      <button class="btn btn-dark btn-full" id="send-btn" onclick="sendCode()">
        Send Code →
      </button>
      <p class="skip-link">
        No account yet? 
        <button class="skip-btn" onclick="goStage()">Start without one</button>
      </p>
    </div>

    <!-- Step 2: OTP entry -->
    <div class="step" id="step-otp">
      <h2 class="signin-h2">Check your email.</h2>
      <p class="signin-sub" style="margin-bottom:14px">We sent a 6-digit code to:</p>
      <div class="email-shown" id="otp-email-shown">—</div>

      <label class="field-label">Enter code</label>
      <div class="otp-row">
        <input class="otp-digit" maxlength="1" id="d0" inputmode="numeric" oninput="otpIn(0)" onkeydown="otpKey(event,0)">
        <input class="otp-digit" maxlength="1" id="d1" inputmode="numeric" oninput="otpIn(1)" onkeydown="otpKey(event,1)">
        <input class="otp-digit" maxlength="1" id="d2" inputmode="numeric" oninput="otpIn(2)" onkeydown="otpKey(event,2)">
        <input class="otp-digit" maxlength="1" id="d3" inputmode="numeric" oninput="otpIn(3)" onkeydown="otpKey(event,3)">
        <input class="otp-digit" maxlength="1" id="d4" inputmode="numeric" oninput="otpIn(4)" onkeydown="otpKey(event,4)">
        <input class="otp-digit" maxlength="1" id="d5" inputmode="numeric" oninput="otpIn(5)" onkeydown="otpKey(event,5)">
      </div>
      <div id="otp-error" style="display:none;color:#cc4444;font-size:13px;margin-bottom:12px"></div>

      <button class="btn btn-dark btn-full" id="verify-btn" onclick="verifyCode()">
        Verify & Sign In →
      </button>

      <div class="resend-row">
        Didn't get it?
        <button class="resend-btn" onclick="resendCode()">Send again</button>
      </div>
      <button class="back-link" onclick="backToEmail()">← Change email</button>
    </div>

    <!-- Step 3: Success -->
    <div class="step" id="step-success">
      <div style="text-align:center;padding:20px 0">
        <div style="font-size:48px;margin-bottom:16px">✓</div>
        <h2 class="signin-h2" style="text-align:center">Signed in!</h2>
        <p style="font-size:14px;color:var(--muted);margin-top:6px">Redirecting you now…</p>
      </div>
    </div>
  </div>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="shared.js"></script>
<script>
// ── Config — replace with your values ──
const SUPABASE_URL = 'https://YOUR_PROJECT.supabase.co';
const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let pendingEmail = '';

// ── Check if already signed in ──
sb.auth.getSession().then(({ data }) => {
  if (data?.session) {
    const dest = sessionStorage.getItem('oa_redirect') || getDefaultDest();
    sessionStorage.removeItem('oa_redirect');
    window.location.href = dest;
  }
});

function getDefaultDest() {
  const stage = localStorage.getItem('oa_stage');
  if (stage) return stage + '.html';
  return 'index.html';
}

// ── Email step ──
async function sendCode() {
  const email = document.getElementById('email-input').value.trim();
  const errEl = document.getElementById('email-error');
  errEl.style.display = 'none';

  if (!email || !email.includes('@')) {
    errEl.textContent = 'Please enter a valid email address.';
    errEl.style.display = 'block';
    return;
  }

  const btn = document.getElementById('send-btn');
  setBtnLoading(btn, true);

  try {
    const { error } = await sb.auth.signInWithOtp({
      email,
      options: { shouldCreateUser: true }
    });
    if (error) throw error;

    pendingEmail = email;
    document.getElementById('otp-email-shown').textContent = email;
    showStep('otp');
    setTimeout(() => document.getElementById('d0').focus(), 100);
  } catch (err) {
    errEl.textContent = err.message || 'Failed to send code. Please try again.';
    errEl.style.display = 'block';
  } finally {
    setBtnLoading(btn, false, 'Send Code →');
  }
}

// ── OTP step ──
function otpIn(idx) {
  const val = document.getElementById('d'+idx).value;
  if (val && idx < 5) {
    document.getElementById('d'+(idx+1)).focus();
  }
  // Auto-verify when all 6 filled
  const full = [0,1,2,3,4,5].map(i => document.getElementById('d'+i).value).join('');
  if (full.length === 6) verifyCode();
}

function otpKey(e, idx) {
  if (e.key === 'Backspace' && !document.getElementById('d'+idx).value && idx > 0) {
    document.getElementById('d'+(idx-1)).focus();
  }
}

async function verifyCode() {
  const token = [0,1,2,3,4,5].map(i => document.getElementById('d'+i).value).join('');
  const errEl = document.getElementById('otp-error');
  errEl.style.display = 'none';

  if (token.length < 6) {
    errEl.textContent = 'Please enter the full 6-digit code.';
    errEl.style.display = 'block';
    return;
  }

  const btn = document.getElementById('verify-btn');
  setBtnLoading(btn, true);

  try {
    const { data, error } = await sb.auth.verifyOtp({
      email: pendingEmail,
      token,
      type: 'email'
    });
    if (error) throw error;

    // Upsert profile
    if (data?.user) {
      const stage = localStorage.getItem('oa_stage');
      await sb.from('profiles').upsert({
        id: data.user.id,
        stage: stage || null,
        updated_at: new Date().toISOString()
      });
    }

    showStep('success');
    setTimeout(() => {
      const dest = sessionStorage.getItem('oa_redirect') || getDefaultDest();
      sessionStorage.removeItem('oa_redirect');
      window.location.href = dest;
    }, 1200);

  } catch (err) {
    errEl.textContent = err.message || 'Invalid code. Please try again.';
    errEl.style.display = 'block';
    setBtnLoading(btn, false, 'Verify & Sign In →');
  }
}

async function resendCode() {
  if (!pendingEmail) return;
  try {
    await sb.auth.signInWithOtp({ email: pendingEmail, options: { shouldCreateUser: true } });
    toast('Code sent!');
    [0,1,2,3,4,5].forEach(i => document.getElementById('d'+i).value = '');
    document.getElementById('d0').focus();
  } catch (err) {
    toast('Failed to resend. Please try again.');
  }
}

function backToEmail() {
  showStep('email');
  [0,1,2,3,4,5].forEach(i => document.getElementById('d'+i).value = '');
  document.getElementById('otp-error').style.display = 'none';
}

function goStage() {
  const stage = localStorage.getItem('oa_stage');
  window.location.href = stage ? stage + '.html' : 'index.html';
}

function showStep(name) {
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  document.getElementById('step-'+name).classList.add('active');
}

// ── Helpers (inline — no shared.js dep for this page) ──
function toast(msg) {
  document.querySelectorAll('.toast-msg').forEach(e => e.remove());
  const el = document.createElement('div');
  el.className = 'toast-msg'; el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

function setBtnLoading(btn, loading, originalText) {
  if (!btn) return;
  btn.disabled = loading;
  btn.innerHTML = loading ? '<span class="spinner"></span> Please wait…' : (originalText || btn.textContent);
}
</script>
</body>
</html>
