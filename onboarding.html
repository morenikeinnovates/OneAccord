<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Get Started ‚Äî OneAccord</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Onest:wght@400;500;600;700;800;900&family=DM+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="shared.css">
<style>
body { background: var(--surface); }

.onboard-wrap {
  max-width: 600px; margin: 0 auto;
  padding: 52px 24px 80px;
}

/* Steps */
.step { display: none; animation: fadeUp .35s ease; }
.step.active { display: block; }

/* Progress dots */
.pdots {
  display: flex; gap: 8px; margin-bottom: 36px;
}
.pdot {
  height: 8px; border-radius: 4px;
  background: var(--border); transition: all .35s;
  width: 8px;
}
.pdot.active { background: var(--ink); width: 28px; border-radius: 4px; }
.pdot.done   { background: var(--lime); width: 8px; }

/* Stage cards */
.stage-grid {
  display: grid; grid-template-columns: repeat(3, 1fr);
  gap: 12px; margin-bottom: 28px;
}
.stage-card {
  background: #fff; border: 2px solid var(--border);
  border-radius: 16px; padding: 22px 14px;
  text-align: center; cursor: pointer;
  transition: all .22s;
}
.stage-card:hover { border-color: var(--border2); box-shadow: var(--shadow); transform: translateY(-2px); }
.stage-card.selected { border-color: var(--lime); background: var(--lime-bg); }
.stage-card .sc-emoji { font-size: 30px; display: block; margin-bottom: 10px; }
.stage-card .sc-name  { font-size: 15px; font-weight: 700; color: var(--ink); margin-bottom: 4px; }
.stage-card .sc-hint  { font-size: 12px; color: var(--muted); line-height: 1.4; }

/* How-it-works grid */
.how-grid {
  display: grid; grid-template-columns: repeat(3, 1fr);
  gap: 12px; margin-bottom: 32px;
}
.how-card {
  background: #fff; border: 1.5px solid var(--border);
  border-radius: 12px; padding: 18px 14px; text-align: center;
}
.how-num {
  width: 30px; height: 30px; border-radius: 50%;
  background: var(--ink); color: #fff;
  font-size: 13px; font-weight: 700;
  display: flex; align-items: center; justify-content: center;
  margin: 0 auto 10px;
}
.how-label { font-size: 14px; font-weight: 700; color: var(--ink); margin-bottom: 4px; }
.how-desc  { font-size: 12px; color: var(--muted); line-height: 1.5; }

/* Reflection box */
.reflect-box {
  background: #fff; border: 1.5px solid var(--border);
  border-radius: var(--radius); padding: 20px;
  margin-bottom: 20px;
  transition: border-color .2s;
}
.reflect-box:focus-within { border-color: var(--lime); }
.reflect-q { font-size: 16px; font-weight: 600; color: var(--ink); line-height: 1.5; margin-bottom: 12px; }

/* Declaration card */
.decl-card {
  background: var(--ink); border-radius: 16px;
  padding: 30px 28px; margin: 20px 0; text-align: center;
}
.decl-card-label {
  font-size: 11px; font-weight: 700; letter-spacing: .12em;
  text-transform: uppercase; color: var(--lime); margin-bottom: 14px;
}
.decl-card-text {
  font-size: 18px; font-weight: 500; color: #fff;
  line-height: 1.65; font-style: italic;
}

/* Email capture */
.email-capture {
  background: #fff; border: 1.5px solid var(--border);
  border-radius: var(--radius); padding: 22px; margin-top: 20px;
}
.ec-title { font-size: 15px; font-weight: 700; color: var(--ink); margin-bottom: 6px; }
.ec-sub   { font-size: 13px; color: var(--muted); line-height: 1.55; margin-bottom: 16px; }
.ec-row   { display: flex; gap: 10px; }
.ec-input {
  flex: 1; font-family: var(--fb); font-size: 14px;
  color: var(--ink); background: var(--surface);
  border: 1.5px solid var(--border); border-radius: 9px;
  padding: 11px 13px; outline: none; transition: border-color .2s;
}
.ec-input:focus { border-color: var(--lime); }
.ec-btn {
  background: var(--ink); color: #fff; border: none;
  font-family: var(--fb); font-size: 13px; font-weight: 600;
  padding: 11px 18px; border-radius: 9px;
  cursor: pointer; white-space: nowrap; transition: all .2s;
}
.ec-btn:hover { background: var(--ink2); }
.ec-skip {
  display: block; text-align: center; margin-top: 10px;
  font-size: 13px; color: var(--muted);
  background: none; border: none;
  font-family: var(--fb); cursor: pointer;
  width: 100%; transition: color .2s;
}
.ec-skip:hover { color: var(--ink); }

/* Responsive */
@media(max-width:600px) {
  .onboard-wrap { padding: 32px 14px 60px; }
  .stage-grid { grid-template-columns: 1fr; gap: 10px; }
  .how-grid { grid-template-columns: 1fr; gap: 10px; }
  .ec-row { flex-direction: column; }
  .ec-input, .ec-btn { width: 100%; }
}
</style>
</head>
<body>

<nav class="top-nav">
  <a class="nav-logo" href="index.html"><div class="nav-logo-dot"></div>OneAccord</a>
  <span class="nav-spacer"></span>
  <button class="nav-link-btn" id="nav-signin-btn" onclick="window.location.href='signin.html'">Sign in</button>
</nav>

<div class="onboard-wrap">

  <!-- ‚îÄ‚îÄ Step 1: Choose stage ‚îÄ‚îÄ -->
  <div class="step active" id="s1">
    <div class="page-eyebrow">Getting started</div>
    <h1 class="page-h1">Where are you<br>in your relationship?</h1>
    <p class="page-sub">Your stage shapes your recommended session path. You can change this anytime.</p>

    <div class="stage-grid">
      <div class="stage-card" onclick="selectStage('dating', this)">
        <span class="sc-emoji">üå±</span>
        <div class="sc-name">Dating</div>
        <div class="sc-hint">Exploring, building something intentional.</div>
      </div>
      <div class="stage-card" onclick="selectStage('engaged', this)">
        <span class="sc-emoji">üíç</span>
        <div class="sc-name">Engaged</div>
        <div class="sc-hint">Preparing for the covenant of marriage.</div>
      </div>
      <div class="stage-card" onclick="selectStage('married', this)">
        <span class="sc-emoji">üïäÔ∏è</span>
        <div class="sc-name">Married</div>
        <div class="sc-hint">Going deeper, building a lasting foundation.</div>
      </div>
    </div>

    <button class="btn btn-dark btn-full" id="stage-next-btn" disabled onclick="goStep(2)">
      Begin Session Zero ‚Üí
    </button>
  </div>

  <!-- ‚îÄ‚îÄ Step 2: How it works ‚îÄ‚îÄ -->
  <div class="step" id="s2">
    <div class="pdots">
      <div class="pdot active" id="dot1"></div>
      <div class="pdot" id="dot2"></div>
      <div class="pdot" id="dot3"></div>
      <div class="pdot" id="dot4"></div>
    </div>

    <div class="page-eyebrow">Session Zero</div>
    <h1 class="page-h1">Before you begin,<br>understand the structure.</h1>
    <p class="page-sub">Every session moves through four phases designed to surface, share, and seal what you believe together.</p>

    <div class="how-grid">
      <div class="how-card">
        <div class="how-num">1</div>
        <div class="how-label">My Story</div>
        <div class="how-desc">Private reflection on your own experience. Yours alone until you share.</div>
      </div>
      <div class="how-card">
        <div class="how-num">2</div>
        <div class="how-label">Your Story</div>
        <div class="how-desc">Your observations and understanding of your partner.</div>
      </div>
      <div class="how-card">
        <div class="how-num">3</div>
        <div class="how-label">Our Middle</div>
        <div class="how-desc">From two perspectives to one shared position.</div>
      </div>
    </div>

    <button class="btn btn-dark btn-full" onclick="goStep(3)">Continue ‚Üí</button>
    <button class="btn btn-ghost btn-full" onclick="goStep(1)" style="margin-top:8px">‚Üê Back</button>
  </div>

  <!-- ‚îÄ‚îÄ Step 3: My Story ‚îÄ‚îÄ -->
  <div class="step" id="s3">
    <div class="pdots">
      <div class="pdot done" id="dot1"></div>
      <div class="pdot active" id="dot2"></div>
      <div class="pdot" id="dot3"></div>
      <div class="pdot" id="dot4"></div>
    </div>

    <div class="page-eyebrow">My Story ‚Äî Your turn first</div>
    <h1 class="page-h1">Reflect before<br>you share.</h1>
    <p class="page-sub" style="margin-bottom:20px">This is private ‚Äî just for you, unless you choose to share it.</p>

    <div class="reflect-box">
      <div class="reflect-q">What is the one thing you most want this relationship to be defined by ‚Äî above everything else?</div>
      <textarea class="field-textarea" id="q1" placeholder="Write your reflection here ‚Äî this is just for you‚Ä¶" rows="4"></textarea>
    </div>

    <button class="btn btn-dark btn-full" onclick="goStep(4)">Continue ‚Üí</button>
    <button class="btn btn-ghost btn-full" onclick="goStep(2)" style="margin-top:8px">‚Üê Back</button>
  </div>

  <!-- ‚îÄ‚îÄ Step 4: Your Story + Declaration ‚îÄ‚îÄ -->
  <div class="step" id="s4">
    <div class="pdots">
      <div class="pdot done"></div>
      <div class="pdot done"></div>
      <div class="pdot active"></div>
      <div class="pdot" id="dot4b"></div>
    </div>

    <div class="page-eyebrow">Your Story ‚Äî Now understand them</div>
    <h1 class="page-h1">What do you know<br>about your partner?</h1>

    <div class="reflect-box">
      <div class="reflect-q">What do you think your partner most wants this relationship to be defined by?</div>
      <textarea class="field-textarea" id="q2" placeholder="Your observation of who they are‚Ä¶" rows="4"></textarea>
    </div>

    <button class="btn btn-lime btn-full" id="gen-btn" onclick="generateDeclaration()">
      Generate My First Declaration ‚Üí
    </button>
    <button class="btn btn-ghost btn-full" onclick="goStep(3)" style="margin-top:8px">‚Üê Back</button>
  </div>

  <!-- ‚îÄ‚îÄ Step 5: Declaration ‚îÄ‚îÄ -->
  <div class="step" id="s5">
    <div class="pdots">
      <div class="pdot done"></div>
      <div class="pdot done"></div>
      <div class="pdot done"></div>
      <div class="pdot active"></div>
    </div>

    <div class="page-eyebrow">Your First Declaration</div>
    <h1 class="page-h1" style="text-align:center">Here it is.</h1>

    <div class="decl-card">
      <div class="decl-card-label">‚ú¶ Your Declaration</div>
      <div class="decl-card-text" id="decl-out">Generating‚Ä¶</div>
    </div>

    <p style="font-size:14px;color:var(--muted);line-height:1.7;text-align:center;margin-bottom:20px">
      This is what a declaration looks like. Every session ends with one ‚Äî sealed permanently into your shared archive.
    </p>

    <!-- Email capture (hidden if already signed in) -->
    <div class="email-capture" id="email-capture-box">
      <div class="ec-title">Save your progress?</div>
      <div class="ec-sub">Enter your email to preserve your declarations across sessions and devices ‚Äî no password, ever.</div>
      <div class="ec-row">
        <input class="ec-input" type="email" id="capture-email" placeholder="your@email.com"
          onkeydown="if(event.key==='Enter')saveEmailAndContinue()">
        <button class="ec-btn" onclick="saveEmailAndContinue()">Save ‚Üí</button>
      </div>
      <button class="ec-skip" onclick="skipEmailCapture()">Skip for now</button>
    </div>

    <!-- Enter library (shown after email saved or skipped) -->
    <button class="btn btn-dark btn-full" id="enter-lib-btn" style="display:none;margin-top:16px" onclick="enterLibrary()">
      Enter Session Library ‚Üí
    </button>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ‚îÄ‚îÄ Supabase config ‚îÄ‚îÄ
const SUPABASE_URL = 'https://YOUR_PROJECT.supabase.co';
const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let selectedStage = localStorage.getItem('oa_stage') || null;
let currentStep   = 1;

// ‚îÄ‚îÄ Boot ‚îÄ‚îÄ
(async () => {
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    // Already signed in ‚Äî hide sign-in button, show initial
    const initial = session.user.email[0].toUpperCase();
    document.getElementById('nav-signin-btn').innerHTML =
      `<button class="nav-user-btn" onclick="window.location.href='profile.html'">${initial}</button>`;
    document.getElementById('nav-signin-btn').style.cssText = '';
  }

  // Pre-select stage if saved
  if (selectedStage) {
    const map = { dating: 0, engaged: 1, married: 2 };
    const idx = map[selectedStage];
    if (idx !== undefined) {
      const cards = document.querySelectorAll('.stage-card');
      cards[idx]?.classList.add('selected');
      document.getElementById('stage-next-btn').disabled = false;
    }
  }
})();

// ‚îÄ‚îÄ Stage selection ‚îÄ‚îÄ
function selectStage(stage, el) {
  selectedStage = stage;
  document.querySelectorAll('.stage-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('stage-next-btn').disabled = false;
}

// ‚îÄ‚îÄ Step navigation ‚îÄ‚îÄ
function goStep(n) {
  document.getElementById('s' + currentStep).classList.remove('active');
  currentStep = n;
  document.getElementById('s' + n).classList.add('active');
  window.scrollTo(0, 0);
}

// ‚îÄ‚îÄ Generate declaration (step 4 ‚Üí 5) ‚îÄ‚îÄ
async function generateDeclaration() {
  const q1 = (document.getElementById('q1').value || '').trim();
  const q2 = (document.getElementById('q2').value || '').trim();

  // Save stage
  if (selectedStage) localStorage.setItem('oa_stage', selectedStage);

  // Transition to step 5
  goStep(5);

  const declEl = document.getElementById('decl-out');
  declEl.textContent = '‚ú¶ Crafting your declaration‚Ä¶';

  const fallback = "We agree that this relationship should be defined by faith, honesty, and the willingness to always choose each other.";

  try {
    const text = await aiDeclaration(q1, q2);
    declEl.textContent = '"' + (text || fallback) + '"';
  } catch(e) {
    declEl.textContent = '"' + fallback + '"';
  }

  // Check if already signed in
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    document.getElementById('email-capture-box').style.display = 'none';
    document.getElementById('enter-lib-btn').style.display = 'block';

    // Save declaration to Supabase
    try {
      await sb.from('declarations').insert({
        user_id: session.user.id,
        session_id: 'session-zero',
        session_title: 'Session Zero',
        category: 'Onboarding',
        stage: selectedStage || 'dating',
        mode: 'deep',
        declaration: document.getElementById('decl-out').textContent.replace(/^"|"$/g, '')
      });
    } catch(e) { console.warn('Save declaration:', e.message); }
  }
}

// ‚îÄ‚îÄ Email capture (anonymous users) ‚îÄ‚îÄ
function saveEmailAndContinue() {
  const email = (document.getElementById('capture-email').value || '').trim();
  if (!email || !email.includes('@')) { toast('Please enter a valid email.'); return; }
  sessionStorage.setItem('oa_redirect', (selectedStage || 'dating') + '.html');
  window.location.href = 'signin.html?pre=' + encodeURIComponent(email);
}

function skipEmailCapture() {
  document.getElementById('email-capture-box').style.display = 'none';
  document.getElementById('enter-lib-btn').style.display = 'block';
}

function enterLibrary() {
  window.location.href = (selectedStage || 'dating') + '.html';
}

// ‚îÄ‚îÄ AI declaration via Claude ‚îÄ‚îÄ
async function aiDeclaration(q1, q2) {
  const prompt = `A Christian couple is writing their first relationship declaration.\nPerson's reflection on what they want the relationship defined by: "${q1 || 'faith and intentionality'}"\nTheir view of what their partner wants: "${q2 || 'similar values and direction'}"\n\nWrite ONE declaration sentence starting exactly with "We agree that" ‚Äî warm, personal, grounded in Christian values. Max 2 sentences. Return ONLY the declaration text, no quotes, no explanation.`;

  const r = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 100,
      messages: [{ role: 'user', content: prompt }]
    })
  });
  if (!r.ok) throw new Error('API ' + r.status);
  const d = await r.json();
  return (d.content || []).filter(b => b.type === 'text').map(b => b.text).join('').trim();
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
function toast(msg) {
  document.querySelectorAll('.toast-msg').forEach(e => e.remove());
  const el = Object.assign(document.createElement('div'), { className: 'toast-msg', textContent: msg });
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}
</script>

</body>
</html>
