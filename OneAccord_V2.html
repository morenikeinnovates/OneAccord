<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OneAccord V2 — Guided Conversations for Couples</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Onest:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior:smooth; }

:root {
  --ink:    #0f1a14;
  --ink2:   #2a3a30;
  --muted:  #6b7c73;
  --subtle: #a8b8af;
  --lime:   #b8e04a;
  --lime2:  #d4f07a;
  --lime-bg:#f0f9d8;
  --amber:  #f0a832;
  --amber-bg:#fef6e4;
  --surface:#f7faf5;
  --card:   #ffffff;
  --border: #e4ece6;
  --border2:#d0ddd4;
  --radius: 14px;
  --shadow: 0 2px 20px rgba(15,26,20,0.07);
  --shadow2:0 8px 40px rgba(15,26,20,0.12);
}

body {
  font-family:'Onest','Onest Placeholder',sans-serif;
  background:#fff;
  color:var(--ink);
  min-height:100vh;
  -webkit-font-smoothing:antialiased;
}

/* ── SCREENS ─── */
.screen { display:none; min-height:100vh; flex-direction:column; }
.screen.active { display:flex; }

@keyframes fadeUp {
  from { opacity:0; transform:translateY(16px); }
  to   { opacity:1; transform:translateY(0); }
}
@keyframes fadeIn {
  from { opacity:0; }
  to   { opacity:1; }
}
@keyframes pulse {
  0%,100% { opacity:1; }
  50% { opacity:0.5; }
}

/* ══════════════════════════════════════════
   LANDING
══════════════════════════════════════════ */
#screen-landing {
  background:#fff;
  position:relative; overflow:hidden;
}

.land-nav {
  position:sticky; top:0; z-index:100;
  display:flex; align-items:center;
  padding:0 48px; height:64px;
  background:rgba(255,255,255,0.92);
  backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border);
}
.land-logo {
  font-size:18px; font-weight:700;
  color:var(--ink); cursor:pointer;
  letter-spacing:-0.3px;
  display:flex; align-items:center; gap:8px;
}
.land-logo-dot {
  width:8px; height:8px; border-radius:50%;
  background:var(--lime);
}
.land-nav-links { display:flex; gap:28px; margin:0 auto; }
.land-nav-link {
  font-size:14px; font-weight:500; color:var(--muted);
  background:none; border:none; cursor:pointer;
  transition:color 0.2s;
}
.land-nav-link:hover { color:var(--ink); }
.nav-cta {
  background:var(--ink);
  color:#fff; border:none;
  font-family:inherit; font-size:14px; font-weight:600;
  padding:10px 22px; border-radius:8px;
  cursor:pointer; transition:all 0.2s;
}
.nav-cta:hover { background:var(--ink2); transform:translateY(-1px); }
.nav-login-link {
  font-size:14px; font-weight:500; color:var(--muted);
  background:none; border:none; cursor:pointer; margin-right:12px;
  transition:color 0.2s;
}
.nav-login-link:hover { color:var(--ink); }

.land-hero {
  display:grid; grid-template-columns:1fr 480px;
  gap:40px; align-items:center;
  padding:80px 80px 60px;
  max-width:1200px; margin:0 auto; width:100%;
}
.hero-badge {
  display:inline-flex; align-items:center; gap:8px;
  background:var(--lime-bg); border:1px solid #c8e87a;
  padding:5px 12px; border-radius:100px;
  font-size:12px; font-weight:600; color:#4a6b1a;
  margin-bottom:20px;
}
.hero-badge-dot { width:6px; height:6px; border-radius:50%; background:var(--lime); }
.hero-h1 {
  font-size:clamp(40px,5vw,62px);
  font-weight:800; line-height:1.08;
  letter-spacing:-1.5px; color:var(--ink);
  margin-bottom:20px;
}
.hero-h1 em { font-style:normal; color:var(--muted); font-weight:400; }
.hero-sub {
  font-size:17px; font-weight:400; color:var(--muted);
  line-height:1.65; max-width:440px; margin-bottom:36px;
}
.hero-btns { display:flex; gap:12px; flex-wrap:wrap; }
.btn-dark {
  background:var(--ink); color:#fff; border:none;
  font-family:inherit; font-size:15px; font-weight:600;
  padding:14px 28px; border-radius:9px;
  cursor:pointer; display:flex; align-items:center; gap:8px;
  transition:all 0.2s;
}
.btn-dark:hover { background:var(--ink2); transform:translateY(-1px); box-shadow:var(--shadow2); }
.btn-outline {
  background:transparent; color:var(--ink);
  border:1.5px solid var(--border2);
  font-family:inherit; font-size:15px; font-weight:500;
  padding:14px 28px; border-radius:9px;
  cursor:pointer; transition:all 0.2s;
}
.btn-outline:hover { border-color:var(--ink); }

.hero-visual { position:relative; }
.hero-card {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:20px;
  padding:28px; position:relative; overflow:hidden;
}
.hero-card-title {
  font-size:13px; font-weight:600; color:var(--muted);
  letter-spacing:0.05em; text-transform:uppercase;
  margin-bottom:16px;
}
.session-preview-items { display:flex; flex-direction:column; gap:10px; }
.spi {
  background:#fff; border:1px solid var(--border);
  border-radius:10px; padding:14px 16px;
  display:flex; align-items:center; gap:12px;
  transition:all 0.2s;
}
.spi:first-child { border-color:#c8e87a; background:var(--lime-bg); }
.spi-emoji { font-size:18px; }
.spi-text { flex:1; }
.spi-name { font-size:14px; font-weight:600; color:var(--ink); }
.spi-sub { font-size:12px; color:var(--muted); margin-top:1px; }
.spi-badge {
  font-size:11px; font-weight:600;
  background:var(--lime); color:#2a4010;
  padding:3px 8px; border-radius:100px;
}
.spi-badge-gray {
  font-size:11px; font-weight:500; color:var(--subtle);
  background:var(--surface); border:1px solid var(--border);
  padding:3px 8px; border-radius:100px;
}
.spi-badge-amber {
  font-size:11px; font-weight:600;
  background:var(--amber-bg); color:#8a5a00;
  padding:3px 8px; border-radius:100px;
}

.trust-bar {
  border-top:1px solid var(--border);
  padding:28px 80px;
  display:flex; align-items:center; gap:32px;
  max-width:1200px; margin:0 auto; width:100%;
}
.trust-label { font-size:13px; color:var(--subtle); font-weight:500; }
.trust-items { display:flex; gap:24px; }
.trust-item {
  font-size:13px; font-weight:600; color:var(--muted);
  display:flex; align-items:center; gap:6px;
}
.trust-check { color:var(--lime); font-size:14px; }

.land-section {
  padding:80px 80px;
  max-width:1200px; margin:0 auto; width:100%;
}
.section-label {
  font-size:12px; font-weight:700;
  letter-spacing:0.12em; text-transform:uppercase;
  color:var(--lime); background:var(--lime-bg);
  padding:4px 12px; border-radius:100px;
  display:inline-block; margin-bottom:16px;
}
.section-h2 {
  font-size:clamp(28px,4vw,44px);
  font-weight:800; line-height:1.1;
  letter-spacing:-1px; color:var(--ink);
  margin-bottom:12px;
}
.section-sub {
  font-size:16px; color:var(--muted); font-weight:400;
  line-height:1.6; max-width:500px; margin-bottom:52px;
}

.feature-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px; }
.feat-card {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:28px; transition:all 0.25s;
  position:relative; overflow:hidden;
}
.feat-card:hover { box-shadow:var(--shadow2); transform:translateY(-3px); border-color:var(--border2); }
.feat-icon {
  width:44px; height:44px;
  background:var(--lime); border-radius:10px;
  display:flex; align-items:center; justify-content:center;
  font-size:20px; margin-bottom:16px;
}
.feat-title { font-size:17px; font-weight:700; color:var(--ink); margin-bottom:8px; }
.feat-desc { font-size:14px; color:var(--muted); line-height:1.6; }

.how-section {
  background:var(--ink); color:#fff;
  padding:80px;
}
.how-inner { max-width:1200px; margin:0 auto; }
.how-section .section-label { background:rgba(184,224,74,0.15); color:var(--lime); }
.how-section .section-h2 { color:#fff; }
.how-section .section-sub { color:rgba(255,255,255,0.55); }
.how-steps { display:grid; grid-template-columns:repeat(3,1fr); gap:32px; }
.how-step { position:relative; }
.how-step-num {
  font-size:11px; font-weight:700; letter-spacing:0.1em;
  color:var(--lime); margin-bottom:16px;
  display:flex; align-items:center; gap:8px;
}
.how-step-num::after {
  content:''; flex:1; height:1px;
  background:rgba(255,255,255,0.08);
}
.how-step-title { font-size:20px; font-weight:700; color:#fff; margin-bottom:10px; }
.how-step-desc { font-size:14px; color:rgba(255,255,255,0.5); line-height:1.65; }

.cta-section {
  padding:80px; text-align:center;
  background:var(--surface);
  border-top:1px solid var(--border);
  border-bottom:1px solid var(--border);
}
.cta-section .section-h2 { margin:0 auto 12px; }
.cta-section .section-sub { margin:0 auto 36px; }
.cta-btns { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }

.land-footer {
  padding:40px 80px;
  display:flex; align-items:center; justify-content:space-between;
  border-top:1px solid var(--border);
}
.footer-logo { font-size:16px; font-weight:700; color:var(--ink); display:flex; align-items:center; gap:6px; }
.footer-copy { font-size:13px; color:var(--subtle); }

/* ══════════════════════════════════════════
   AUTH SCREENS (Login / OTP)
══════════════════════════════════════════ */
#screen-auth, #screen-otp { background:#fff; }

.auth-wrap {
  flex:1; display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  padding:60px 24px;
}
.auth-box {
  width:100%; max-width:420px;
  background:#fff; border:1.5px solid var(--border);
  border-radius:20px; padding:40px;
  box-shadow:var(--shadow2);
}
.auth-logo {
  display:flex; align-items:center; gap:8px;
  font-size:18px; font-weight:700; color:var(--ink);
  margin-bottom:32px;
}
.auth-logo-dot { width:8px; height:8px; border-radius:50%; background:var(--lime); }
.auth-h2 { font-size:24px; font-weight:800; letter-spacing:-0.5px; color:var(--ink); margin-bottom:8px; }
.auth-sub { font-size:14px; color:var(--muted); line-height:1.6; margin-bottom:28px; }
.auth-label {
  font-size:12px; font-weight:700; letter-spacing:0.06em;
  text-transform:uppercase; color:var(--muted); margin-bottom:8px; display:block;
}
.auth-input {
  width:100%; font-family:inherit; font-size:16px; font-weight:400;
  color:var(--ink); background:var(--surface);
  border:1.5px solid var(--border); border-radius:10px;
  padding:13px 16px; transition:border-color 0.2s; outline:none;
  margin-bottom:16px;
}
.auth-input:focus { border-color:var(--lime); }
.auth-btn {
  width:100%; background:var(--ink); color:#fff; border:none;
  font-family:inherit; font-size:15px; font-weight:600;
  padding:14px; border-radius:10px; cursor:pointer;
  transition:all 0.2s;
}
.auth-btn:hover { background:var(--ink2); }
.auth-skip {
  text-align:center; margin-top:16px;
  font-size:13px; color:var(--muted);
}
.auth-skip-link {
  color:var(--muted); text-decoration:underline; cursor:pointer;
  background:none; border:none; font-family:inherit; font-size:13px;
}
.auth-skip-link:hover { color:var(--ink); }
.otp-inputs {
  display:flex; gap:10px; margin-bottom:20px;
}
.otp-digit {
  width:52px; height:60px; text-align:center;
  font-family:inherit; font-size:24px; font-weight:700;
  border:1.5px solid var(--border); border-radius:10px;
  background:var(--surface); outline:none; color:var(--ink);
  transition:border-color 0.2s;
}
.otp-digit:focus { border-color:var(--lime); }
.auth-email-shown {
  background:var(--lime-bg); border:1px solid #c8e87a;
  border-radius:8px; padding:10px 14px;
  font-size:14px; font-weight:600; color:#4a6b1a;
  margin-bottom:20px;
}
.auth-resend {
  font-size:13px; color:var(--muted); text-align:center; margin-top:12px;
}
.auth-resend-link { color:var(--ink); cursor:pointer; text-decoration:underline; background:none; border:none; font-family:inherit; font-size:13px; }

/* ══════════════════════════════════════════
   EMAIL CAPTURE MODAL
══════════════════════════════════════════ */
.modal-overlay {
  position:fixed; inset:0; z-index:999;
  background:rgba(15,26,20,0.5); backdrop-filter:blur(4px);
  display:none; align-items:center; justify-content:center;
}
.modal-overlay.show { display:flex; animation:fadeIn 0.2s; }
.modal-box {
  background:#fff; border-radius:20px; padding:40px;
  max-width:440px; width:100%; margin:20px;
  box-shadow:0 24px 80px rgba(15,26,20,0.2);
  animation:fadeUp 0.3s ease;
}
.modal-h3 { font-size:22px; font-weight:800; letter-spacing:-0.5px; margin-bottom:8px; }
.modal-sub { font-size:14px; color:var(--muted); line-height:1.65; margin-bottom:24px; }
.modal-input {
  width:100%; font-family:inherit; font-size:15px;
  color:var(--ink); background:var(--surface);
  border:1.5px solid var(--border); border-radius:10px;
  padding:13px 16px; outline:none; margin-bottom:12px;
  transition:border-color 0.2s;
}
.modal-input:focus { border-color:var(--lime); }
.modal-btn {
  width:100%; background:var(--ink); color:#fff; border:none;
  font-family:inherit; font-size:15px; font-weight:600;
  padding:14px; border-radius:10px; cursor:pointer;
  transition:all 0.2s; margin-bottom:10px;
}
.modal-btn:hover { background:var(--ink2); }
.modal-skip {
  width:100%; background:none; border:none; color:var(--muted);
  font-family:inherit; font-size:13px; cursor:pointer;
  padding:8px; text-align:center;
}
.modal-skip:hover { color:var(--ink); }

/* ══════════════════════════════════════════
   SHARED NAV (inner screens)
══════════════════════════════════════════ */
.top-nav {
  height:60px; background:#fff;
  border-bottom:1px solid var(--border);
  display:flex; align-items:center;
  padding:0 40px; gap:20px;
  position:sticky; top:0; z-index:100;
  flex-shrink:0;
}
.nav-logo {
  font-size:17px; font-weight:700; color:var(--ink);
  cursor:pointer; display:flex; align-items:center; gap:7px;
  text-decoration:none;
  transition:opacity 0.2s;
}
.nav-logo:hover { opacity:0.7; }
.nav-logo-dot { width:7px; height:7px; border-radius:50%; background:var(--lime); }
.nav-back {
  margin-left:auto;
  background:none; border:1px solid var(--border);
  font-family:inherit; font-size:13px; font-weight:500;
  color:var(--muted); padding:7px 16px; border-radius:7px;
  cursor:pointer; transition:all 0.2s; display:flex; align-items:center; gap:6px;
}
.nav-back:hover { border-color:var(--ink); color:var(--ink); }
.nav-tabs {
  display:flex; gap:4px; margin:0 auto;
}
.nav-tab {
  font-family:inherit; font-size:13px; font-weight:600;
  padding:7px 18px; border-radius:8px; border:none;
  background:none; color:var(--muted); cursor:pointer; transition:all 0.2s;
}
.nav-tab.active { background:var(--surface); color:var(--ink); }

/* User/profile area in nav */
.nav-user {
  margin-left:auto; display:flex; align-items:center; gap:10px;
}
.nav-user-name {
  font-size:13px; font-weight:600; color:var(--muted);
}
.nav-partner-badge {
  display:flex; align-items:center; gap:6px;
  background:var(--lime-bg); border:1px solid #c8e87a;
  padding:4px 10px; border-radius:100px;
  font-size:12px; font-weight:600; color:#4a6b1a;
}
.nav-partner-dot {
  width:6px; height:6px; border-radius:50%;
  background:var(--lime);
}
.nav-profile-btn {
  width:32px; height:32px; border-radius:50%;
  background:var(--ink); color:#fff;
  font-size:12px; font-weight:700;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; border:none; font-family:inherit;
  transition:all 0.2s;
}
.nav-profile-btn:hover { background:var(--ink2); transform:scale(1.05); }

/* ══════════════════════════════════════════
   STAGE SELECTOR
══════════════════════════════════════════ */
#screen-stage { background:#fff; }

.page-body {
  flex:1; display:flex; flex-direction:column;
  align-items:center; padding:60px 24px;
}

.page-eyebrow {
  font-size:12px; font-weight:700; letter-spacing:0.1em;
  text-transform:uppercase; color:var(--lime);
  background:var(--lime-bg); padding:4px 12px;
  border-radius:100px; margin-bottom:16px;
}
.page-h1 {
  font-size:clamp(28px,4vw,40px); font-weight:800;
  letter-spacing:-0.8px; color:var(--ink);
  text-align:center; margin-bottom:10px; line-height:1.15;
}
.page-sub {
  font-size:15px; color:var(--muted); text-align:center;
  max-width:440px; line-height:1.65; margin-bottom:48px;
}

.stage-cards {
  display:grid; grid-template-columns:repeat(3,1fr);
  gap:16px; width:100%; max-width:780px; margin-bottom:40px;
}
.stage-card {
  background:var(--surface); border:1.5px solid var(--border);
  border-radius:var(--radius); padding:28px 22px;
  cursor:pointer; transition:all 0.22s; text-align:center;
}
.stage-card:hover { border-color:var(--border2); box-shadow:var(--shadow); transform:translateY(-2px); }
.stage-card.selected { border-color:var(--lime); background:var(--lime-bg); }
.stage-card-emoji { font-size:32px; margin-bottom:12px; display:block; }
.stage-card-name { font-size:16px; font-weight:700; color:var(--ink); margin-bottom:6px; }
.stage-card-hint { font-size:13px; color:var(--muted); line-height:1.5; }

/* ══════════════════════════════════════════
   SESSION ZERO
══════════════════════════════════════════ */
#screen-zero { background:#fff; }

.zero-body {
  flex:1; display:flex; flex-direction:column;
  align-items:center; padding:52px 24px;
  max-width:640px; margin:0 auto; width:100%;
}

.zero-step { display:none; flex-direction:column; align-items:center; width:100%; }
.zero-step.active { display:flex; }

.progress-row {
  display:flex; gap:6px; margin-bottom:44px;
}
.pdot {
  width:24px; height:4px; border-radius:2px;
  background:var(--border); transition:all 0.3s;
}
.pdot.done { background:var(--lime); }
.pdot.active { background:var(--ink); }

.how-grid {
  display:grid; grid-template-columns:repeat(3,1fr);
  gap:14px; width:100%; margin:24px 0 36px;
}
.how-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); padding:22px 18px; text-align:center;
}
.how-num {
  font-size:28px; font-weight:800; color:var(--lime);
  line-height:1; margin-bottom:10px;
}
.how-label { font-size:13px; font-weight:700; color:var(--ink); margin-bottom:6px; }
.how-desc { font-size:12px; color:var(--muted); line-height:1.5; }

.z-question {
  width:100%; background:var(--surface);
  border:1.5px solid var(--border);
  border-radius:var(--radius); padding:24px;
  margin:20px 0;
}
.z-q-text { font-size:17px; font-weight:600; color:var(--ink); line-height:1.5; margin-bottom:14px; }
.z-input {
  width:100%; font-family:inherit; font-size:14px; font-weight:400;
  color:var(--ink); background:#fff;
  border:1px solid var(--border); border-radius:8px;
  padding:12px 14px; resize:vertical; min-height:80px;
  line-height:1.6; transition:border-color 0.2s;
}
.z-input:focus { outline:none; border-color:var(--lime); }

.decl-success {
  width:100%; background:var(--ink); border-radius:var(--radius);
  padding:32px; text-align:center; margin:20px 0;
}
.ds-label {
  font-size:11px; font-weight:700; letter-spacing:0.12em;
  text-transform:uppercase; color:var(--lime); margin-bottom:14px;
}
.ds-text {
  font-size:20px; font-weight:600; color:#fff;
  line-height:1.5; font-style:italic;
}

/* Email capture within zero */
.email-capture-soft {
  width:100%; background:var(--surface); border:1.5px solid var(--border);
  border-radius:var(--radius); padding:24px; margin-top:20px;
}
.ecs-title { font-size:16px; font-weight:700; color:var(--ink); margin-bottom:6px; }
.ecs-sub { font-size:13px; color:var(--muted); line-height:1.5; margin-bottom:16px; }
.ecs-row { display:flex; gap:10px; }
.ecs-input {
  flex:1; font-family:inherit; font-size:14px;
  color:var(--ink); background:#fff;
  border:1.5px solid var(--border); border-radius:9px;
  padding:11px 14px; outline:none;
  transition:border-color 0.2s;
}
.ecs-input:focus { border-color:var(--lime); }
.ecs-btn {
  background:var(--ink); color:#fff; border:none;
  font-family:inherit; font-size:13px; font-weight:600;
  padding:11px 18px; border-radius:9px; cursor:pointer;
  white-space:nowrap; transition:all 0.2s;
}
.ecs-btn:hover { background:var(--ink2); }
.ecs-skip {
  font-size:12px; color:var(--subtle); text-align:center;
  margin-top:10px; cursor:pointer; background:none; border:none;
  font-family:inherit; display:block; width:100%;
}
.ecs-skip:hover { color:var(--muted); }

/* ══════════════════════════════════════════
   LIBRARY
══════════════════════════════════════════ */
#screen-library, #screen-declarations, #screen-progress { background:var(--surface); }

.library-wrap { flex:1; padding:40px 48px; max-width:1100px; margin:0 auto; width:100%; }

.lib-top { display:flex; align-items:flex-end; justify-content:space-between; margin-bottom:36px; }
.stage-pill {
  display:inline-flex; align-items:center; gap:6px;
  background:#fff; border:1px solid var(--border);
  border-radius:100px; padding:5px 14px;
  font-size:13px; font-weight:600; color:var(--muted);
}

/* Couple space banner */
.couple-banner {
  background:var(--lime-bg); border:1.5px solid #c8e87a;
  border-radius:var(--radius); padding:16px 20px;
  display:flex; align-items:center; gap:14px;
  margin-bottom:28px;
}
.couple-banner-icon { font-size:20px; }
.couple-banner-text { flex:1; }
.couple-banner-title { font-size:14px; font-weight:700; color:var(--ink); margin-bottom:2px; }
.couple-banner-sub { font-size:12px; color:#4a6b1a; }
.couple-banner-btn {
  background:var(--ink); color:#fff; border:none;
  font-family:inherit; font-size:12px; font-weight:600;
  padding:8px 16px; border-radius:7px; cursor:pointer;
  transition:all 0.2s; white-space:nowrap;
}
.couple-banner-btn:hover { background:var(--ink2); }

/* Connect partner CTA (when not synced) */
.connect-cta {
  border:1.5px dashed var(--border2); border-radius:var(--radius);
  padding:16px 20px; display:flex; align-items:center; gap:14px;
  margin-bottom:28px; cursor:pointer; transition:all 0.2s;
  background:transparent;
}
.connect-cta:hover { border-color:var(--ink); border-style:solid; }
.connect-cta-icon { font-size:20px; }
.connect-cta-text { flex:1; }
.connect-cta-title { font-size:14px; font-weight:700; color:var(--ink); margin-bottom:2px; }
.connect-cta-sub { font-size:12px; color:var(--muted); }
.connect-cta-arrow { font-size:16px; color:var(--muted); }

.rec-section { margin-bottom:48px; }
.rec-heading {
  font-size:12px; font-weight:700; letter-spacing:0.1em;
  text-transform:uppercase; color:var(--subtle);
  margin-bottom:14px; display:flex; align-items:center; gap:10px;
}
.rec-heading::after { content:''; flex:1; height:1px; background:var(--border); }

.rec-path { display:flex; gap:10px; overflow-x:auto; padding-bottom:4px; }
.rec-step {
  background:#fff; border:1.5px solid var(--border);
  border-radius:10px; padding:14px 18px;
  cursor:pointer; display:flex; align-items:center; gap:10px;
  transition:all 0.22s; white-space:nowrap; flex-shrink:0;
}
.rec-step:hover { border-color:var(--ink); box-shadow:var(--shadow); transform:translateY(-2px); }
.rec-step-num {
  width:24px; height:24px; border-radius:6px;
  background:var(--lime); color:#2a4010;
  font-size:12px; font-weight:800;
  display:flex; align-items:center; justify-content:center;
}
.rec-step-name { font-size:14px; font-weight:600; color:var(--ink); }

.all-cats-heading {
  font-size:12px; font-weight:700; letter-spacing:0.1em;
  text-transform:uppercase; color:var(--subtle);
  margin-bottom:14px; display:flex; align-items:center; gap:10px;
}
.all-cats-heading::after { content:''; flex:1; height:1px; background:var(--border); }

.cat-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:14px; }
.cat-card {
  background:#fff; border:1.5px solid var(--border);
  border-radius:var(--radius); padding:22px 20px;
  cursor:pointer; transition:all 0.22s; position:relative;
  overflow:hidden;
}
.cat-card:hover { border-color:var(--border2); box-shadow:var(--shadow); transform:translateY(-2px); }
.cat-emoji { font-size:22px; margin-bottom:10px; display:block; }
.cat-name { font-size:15px; font-weight:700; color:var(--ink); margin-bottom:3px; }
.cat-count { font-size:12px; color:var(--muted); margin-bottom:10px; }
/* Progress bar on category card */
.cat-progress-bar {
  height:3px; background:var(--border);
  border-radius:2px; overflow:hidden; margin-top:8px;
}
.cat-progress-fill {
  height:100%; background:var(--lime);
  border-radius:2px; transition:width 0.4s;
}
.cat-complete-badge {
  position:absolute; top:12px; right:12px;
  background:var(--lime); color:#2a4010;
  font-size:10px; font-weight:700; letter-spacing:0.06em;
  padding:2px 7px; border-radius:100px;
}

/* Session cards with status */
.sess-status-bar {
  height:3px; width:4px; border-radius:2px;
  background:var(--lime);
  margin-right:12px; flex-shrink:0;
  align-self:stretch;
}

/* ══════════════════════════════════════════
   PICKER
══════════════════════════════════════════ */
#screen-picker { background:#fff; }

.picker-wrap {
  flex:1; display:flex; flex-direction:column;
  align-items:center; padding:48px 24px;
  max-width:680px; margin:0 auto; width:100%;
}

.session-list { width:100%; margin-bottom:32px; }
.sess-item {
  background:var(--surface); border:1.5px solid var(--border);
  border-radius:var(--radius); padding:18px 22px;
  margin-bottom:10px; cursor:pointer;
  transition:all 0.22s;
}
.sess-item:hover, .sess-item.selected { border-color:var(--ink); background:#fff; box-shadow:var(--shadow); }
.sess-item.selected { border-color:var(--lime); background:var(--lime-bg); }
.sess-item-main { display:flex; align-items:center; justify-content:space-between; margin-bottom:0; }
.sess-title { font-size:16px; font-weight:700; color:var(--ink); }
.sess-sub { font-size:13px; color:var(--muted); margin-top:2px; }
.sess-item-meta { margin-top:10px; padding-top:10px; border-top:1px solid var(--border); display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
.sess-status-badge {
  font-size:11px; font-weight:600; padding:3px 9px; border-radius:100px;
}
.status-completed { background:var(--lime-bg); color:#4a6b1a; border:1px solid #c8e87a; }
.status-in-progress { background:#f0f4ff; color:#3050a0; border:1px solid #c0cff0; }
.status-awaiting { background:var(--amber-bg); color:#8a5a00; border:1px solid #f0cc80; }
.sess-attempts-link {
  font-size:11px; color:var(--muted); cursor:pointer;
  text-decoration:underline; background:none; border:none;
  font-family:inherit;
}
.sess-attempts-link:hover { color:var(--ink); }
.sess-do-again {
  font-size:11px; font-weight:600; color:var(--lime);
  background:none; border:none; cursor:pointer;
  font-family:inherit; display:flex; align-items:center; gap:4px;
  margin-left:auto;
}

.mode-label {
  font-size:12px; font-weight:700; letter-spacing:0.1em;
  text-transform:uppercase; color:var(--subtle);
  width:100%; margin-bottom:14px;
}
.mode-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; width:100%; margin-bottom:36px; }
.mode-card {
  border:1.5px solid var(--border); border-radius:var(--radius);
  padding:22px 20px; cursor:pointer; transition:all 0.22s;
  background:#fff; text-align:left;
}
.mode-card:hover { border-color:var(--border2); box-shadow:var(--shadow); }
.mode-card.selected { border-color:var(--ink); background:var(--ink); }
.mode-card.selected .mode-name { color:#fff; }
.mode-card.selected .mode-time { color:var(--lime); }
.mode-card.selected .mode-desc { color:rgba(255,255,255,0.55); }
.mode-icon { font-size:24px; margin-bottom:10px; }
.mode-name { font-size:16px; font-weight:700; color:var(--ink); margin-bottom:4px; }
.mode-time { font-size:12px; font-weight:600; color:var(--lime); margin-bottom:8px; }
.mode-desc { font-size:13px; color:var(--muted); line-height:1.5; }

/* Previous attempts panel */
.attempts-panel {
  width:100%; margin-bottom:28px;
  border:1.5px solid var(--border); border-radius:var(--radius);
  overflow:hidden; background:#fff;
}
.attempts-panel-header {
  background:var(--surface); padding:14px 18px;
  font-size:12px; font-weight:700; letter-spacing:0.08em;
  text-transform:uppercase; color:var(--muted);
  display:flex; align-items:center; gap:8px;
}
.attempt-item {
  padding:14px 18px; border-top:1px solid var(--border);
  cursor:pointer; transition:background 0.2s;
}
.attempt-item:hover { background:var(--surface); }
.attempt-meta {
  display:flex; align-items:center; gap:10px; margin-bottom:6px;
}
.attempt-date { font-size:12px; font-weight:600; color:var(--muted); }
.attempt-stage-tag {
  font-size:11px; font-weight:600; color:var(--muted);
  background:var(--surface); border:1px solid var(--border);
  padding:2px 7px; border-radius:100px;
}
.attempt-mode-tag {
  font-size:11px; font-weight:600; color:var(--subtle);
}
.attempt-decl {
  font-size:14px; color:var(--ink); line-height:1.6;
  font-style:italic;
  display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
  overflow:hidden;
}
.attempt-decl.expanded {
  -webkit-line-clamp:unset; overflow:visible;
}

/* ══════════════════════════════════════════
   FLASHCARD MODE
══════════════════════════════════════════ */
#screen-flash { background:var(--surface); }

.flash-wrap {
  flex:1; display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  padding:40px 24px; max-width:680px; margin:0 auto; width:100%;
}

.flash-counter {
  font-size:13px; font-weight:600; color:var(--muted);
  margin-bottom:32px;
}

.flashcard-scene {
  width:100%; perspective:1000px;
  margin-bottom:32px; cursor:pointer;
}
.flashcard {
  width:100%; min-height:280px;
  position:relative; transform-style:preserve-3d;
  transition:transform 0.5s ease;
  border-radius:20px;
}
.flashcard.flipped { transform:rotateY(180deg); }
.fc-face {
  position:absolute; inset:0;
  backface-visibility:hidden;
  border-radius:20px; padding:36px;
  display:flex; flex-direction:column;
}
.fc-front {
  background:var(--ink); color:#fff;
  align-items:center; justify-content:center; text-align:center;
}
.fc-back {
  background:var(--lime-bg); border:1.5px solid #c8e87a;
  transform:rotateY(180deg);
  align-items:flex-start; justify-content:flex-start;
}
.fc-tag {
  font-size:11px; font-weight:700; letter-spacing:0.12em;
  text-transform:uppercase; color:var(--lime);
  margin-bottom:20px;
}
.fc-back .fc-tag { color:#4a6b1a; }
.fc-question {
  font-size:22px; font-weight:700; color:#fff;
  line-height:1.4;
}
.fc-hint { font-size:13px; color:rgba(255,255,255,0.4); margin-top:auto; }
.fc-answer-label {
  font-size:13px; font-weight:700; color:#4a6b1a;
  margin-bottom:12px;
}
.fc-answer {
  font-size:15px; color:var(--ink2); line-height:1.6;
  font-style:italic;
}
.fc-prompt {
  font-size:13px; color:var(--muted); margin-top:auto;
}

.flash-controls {
  display:flex; gap:12px; width:100%; justify-content:center;
}
.flash-btn {
  background:#fff; border:1.5px solid var(--border);
  border-radius:10px; padding:12px 24px;
  font-family:inherit; font-size:14px; font-weight:600;
  color:var(--ink); cursor:pointer; transition:all 0.2s;
  display:flex; align-items:center; gap:8px;
}
.flash-btn:hover { border-color:var(--ink); box-shadow:var(--shadow); }
.flash-btn-next {
  background:var(--ink); color:#fff; border-color:var(--ink); flex:1;
}
.flash-btn-next:hover { background:var(--ink2); }
.flash-btn-finish {
  background:var(--lime); color:#2a4010; border-color:var(--lime); flex:1;
}
.flash-btn-finish:hover { background:var(--lime2); }

.flash-progress {
  display:flex; gap:5px; width:100%; margin-bottom:24px;
}
.fp-seg {
  height:3px; flex:1; border-radius:2px;
  background:var(--border); transition:background 0.3s;
}
.fp-seg.done { background:var(--lime); }
.fp-seg.active { background:var(--ink); }

/* Flash declaration screen */
.flash-decl-wrap {
  width:100%; background:var(--ink); border-radius:var(--radius);
  padding:32px; margin:20px 0;
}
.flash-decl-preamble {
  font-size:13px; font-weight:700; letter-spacing:0.08em;
  text-transform:uppercase; color:var(--lime); margin-bottom:14px;
}
.flash-decl-field {
  width:100%; font-family:inherit; font-size:17px; font-weight:500;
  font-style:italic; color:#fff;
  background:transparent; border:none;
  border-bottom:1.5px solid rgba(255,255,255,0.15);
  padding:10px 0; resize:none; min-height:90px;
  line-height:1.7; outline:none; transition:border-color 0.2s;
}
.flash-decl-field::placeholder { color:rgba(255,255,255,0.2); }
.flash-decl-field:focus { border-bottom-color:var(--lime); }
.flash-decl-hint { font-size:12px; color:rgba(255,255,255,0.3); margin-top:12px; }

/* ══════════════════════════════════════════
   DEEP SESSION
══════════════════════════════════════════ */
#screen-session { background:#fff; }

.sess-topbar {
  background:#fff; border-bottom:1px solid var(--border);
  padding:0 40px; height:56px;
  display:flex; align-items:center; gap:20px;
  position:sticky; top:60px; z-index:50;
}
.sess-cat { font-size:13px; font-weight:600; color:var(--muted); }
.sess-prog { display:flex; gap:5px; flex:1; justify-content:center; }
.sp-seg {
  height:3px; width:52px; border-radius:2px;
  background:var(--border); transition:background 0.4s;
}
.sp-seg.done { background:var(--lime); }
.sp-seg.active { background:var(--ink); }
.sess-step-label { font-size:12px; color:var(--subtle); min-width:90px; text-align:right; }

.sess-body {
  flex:1; max-width:740px; margin:0 auto;
  width:100%; padding:48px 32px;
  animation:fadeUp 0.4s ease forwards;
}

.sec-tag {
  font-size:11px; font-weight:700; letter-spacing:0.12em;
  text-transform:uppercase; color:var(--lime);
  background:var(--lime-bg); padding:3px 10px;
  border-radius:100px; display:inline-block; margin-bottom:16px;
}
.sec-title {
  font-size:clamp(26px,4vw,38px); font-weight:800;
  letter-spacing:-0.5px; color:var(--ink);
  line-height:1.15; margin-bottom:24px;
}

.prayer-block {
  background:var(--ink); border-radius:var(--radius);
  padding:32px 36px; position:relative; overflow:hidden;
}
.prayer-block::before {
  content:'"'; position:absolute;
  top:-10px; left:20px;
  font-size:100px; color:rgba(184,224,74,0.1);
  font-family:serif; line-height:1;
}
.prayer-text {
  font-size:20px; font-weight:500;
  color:#fff; line-height:1.6;
  font-style:italic; position:relative; z-index:1;
  margin-bottom:14px;
}
.prayer-cue {
  font-size:12px; font-weight:600; color:var(--lime);
  letter-spacing:0.08em; position:relative; z-index:1;
}

.why-text {
  font-size:16px; color:var(--muted); line-height:1.8;
  margin-bottom:20px;
}
.scripture-block {
  background:var(--lime-bg); border:1px solid #c8e87a;
  border-radius:var(--radius); padding:20px 24px; margin:20px 0;
}
.scripture-verse { font-size:16px; color:var(--ink); line-height:1.6; margin-bottom:8px; font-style:italic; font-weight:500; }
.scripture-ref { font-size:12px; font-weight:700; color:#4a6b1a; letter-spacing:0.06em; }

.q-stack { display:flex; flex-direction:column; gap:16px; }
.q-block {
  background:var(--surface); border:1.5px solid var(--border);
  border-radius:var(--radius); padding:20px 22px;
  transition:border-color 0.2s;
}
.q-block:focus-within { border-color:var(--lime); }
.q-num {
  font-size:11px; font-weight:700; letter-spacing:0.1em;
  color:var(--subtle); text-transform:uppercase; margin-bottom:8px;
}
.q-text { font-size:16px; font-weight:600; color:var(--ink); line-height:1.5; margin-bottom:12px; }
.q-field {
  width:100%; font-family:inherit; font-size:14px; font-weight:400;
  color:var(--ink); background:#fff;
  border:1px solid var(--border); border-radius:8px;
  padding:11px 14px; resize:vertical; min-height:72px;
  line-height:1.6; transition:border-color 0.2s;
}
.q-field:focus { outline:none; border-color:var(--lime); }

/* Save toggle for My Story */
.q-save-toggle {
  display:flex; align-items:center; gap:8px;
  margin-top:10px; cursor:pointer;
}
.q-save-toggle input[type=checkbox] { accent-color:var(--lime); width:14px; height:14px; }
.q-save-label { font-size:12px; color:var(--muted); }

.middle-stack { display:flex; flex-direction:column; gap:14px; }
.mid-item {
  display:flex; gap:14px;
  background:var(--surface); border:1.5px solid var(--border);
  border-radius:var(--radius); padding:18px 20px;
  transition:border-color 0.2s;
}
.mid-item:focus-within { border-color:var(--lime); }
.mid-n {
  font-size:22px; font-weight:800; color:var(--border2);
  flex-shrink:0; width:28px; line-height:1.2;
}
.mid-content { flex:1; }
.mid-prompt { font-size:15px; font-weight:600; color:var(--ink); margin-bottom:10px; line-height:1.4; }

.decl-wrap {
  background:var(--ink); border-radius:var(--radius);
  padding:32px 36px; margin:20px 0;
}
.decl-preamble {
  font-size:22px; font-weight:700; color:var(--lime);
  display:block; margin-bottom:14px; font-style:italic;
}
.decl-field {
  width:100%; font-family:inherit; font-size:17px; font-weight:500;
  font-style:italic; color:#fff;
  background:transparent; border:none;
  border-bottom:1.5px solid rgba(255,255,255,0.15);
  padding:10px 0; resize:none; min-height:90px;
  line-height:1.7; outline:none; transition:border-color 0.2s;
}
.decl-field::placeholder { color:rgba(255,255,255,0.2); }
.decl-field:focus { border-bottom-color:var(--lime); }
.decl-hint { font-size:12px; color:rgba(255,255,255,0.3); margin-top:12px; }

/* Couple sync notice in session */
.couple-sync-notice {
  background:var(--amber-bg); border:1px solid #f0cc80;
  border-radius:10px; padding:14px 18px; margin-bottom:20px;
  font-size:13px; color:#8a5a00; line-height:1.5;
}
.couple-sync-notice strong { font-weight:700; }

.sess-nav {
  display:flex; align-items:center; justify-content:space-between;
  margin-top:48px; padding-top:28px;
  border-top:1px solid var(--border);
}
.btn-back-sess {
  background:none; border:1.5px solid var(--border);
  font-family:inherit; font-size:14px; font-weight:500;
  color:var(--muted); padding:11px 22px; border-radius:9px;
  cursor:pointer; transition:all 0.2s; display:flex; align-items:center; gap:8px;
}
.btn-back-sess:hover { border-color:var(--ink); color:var(--ink); }
.btn-next-sess {
  background:var(--ink); color:#fff; border:none;
  font-family:inherit; font-size:14px; font-weight:600;
  padding:11px 28px; border-radius:9px; cursor:pointer;
  display:flex; align-items:center; gap:8px;
  transition:all 0.2s;
}
.btn-next-sess:hover { background:var(--ink2); }
.btn-finish-sess {
  background:var(--lime); color:#2a4010; border:none;
  font-family:inherit; font-size:14px; font-weight:700;
  padding:11px 28px; border-radius:9px; cursor:pointer;
  display:flex; align-items:center; gap:8px;
  transition:all 0.2s;
}
.btn-finish-sess:hover { background:var(--lime2); transform:translateY(-1px); box-shadow:var(--shadow2); }

/* ══════════════════════════════════════════
   CONFIRM SCREEN
══════════════════════════════════════════ */
#screen-confirm {
  background:#fff;
}

.confirm-body {
  flex:1; display:flex; flex-direction:column;
  align-items:center; padding:80px 24px; text-align:center;
}
.confirm-icon {
  width:72px; height:72px; border-radius:50%;
  background:var(--lime); font-size:32px;
  display:flex; align-items:center; justify-content:center;
  margin-bottom:28px;
}
.confirm-h2 {
  font-size:32px; font-weight:800; letter-spacing:-0.7px;
  color:var(--ink); margin-bottom:10px;
}
.confirm-sub {
  font-size:15px; color:var(--muted); max-width:440px;
  line-height:1.7; margin-bottom:32px;
}
.confirm-decl-card {
  background:var(--ink); border-radius:var(--radius);
  padding:28px 32px; max-width:560px; width:100%;
  margin-bottom:32px; text-align:left;
}
.confirm-decl-label {
  font-size:11px; font-weight:700; letter-spacing:0.12em;
  text-transform:uppercase; color:var(--lime); margin-bottom:12px;
}
.confirm-decl-text {
  font-size:19px; font-weight:600; color:#fff;
  line-height:1.55; font-style:italic;
}
.confirm-btns { display:flex; gap:12px; flex-wrap:wrap; justify-content:center; }

/* Email capture after declaration (medium strength) */
.confirm-email-capture {
  max-width:480px; width:100%;
  border:1.5px solid var(--border); border-radius:var(--radius);
  padding:24px; margin-bottom:28px; text-align:left;
}
.cec-title { font-size:16px; font-weight:700; margin-bottom:6px; }
.cec-sub { font-size:13px; color:var(--muted); line-height:1.5; margin-bottom:14px; }
.cec-row { display:flex; gap:10px; }
.cec-input {
  flex:1; font-family:inherit; font-size:14px;
  color:var(--ink); background:var(--surface);
  border:1.5px solid var(--border); border-radius:9px;
  padding:11px 14px; outline:none;
  transition:border-color 0.2s;
}
.cec-input:focus { border-color:var(--lime); }
.cec-btn {
  background:var(--ink); color:#fff; border:none;
  font-family:inherit; font-size:13px; font-weight:600;
  padding:11px 18px; border-radius:9px; cursor:pointer;
  white-space:nowrap; transition:all 0.2s;
}
.cec-btn:hover { background:var(--ink2); }
.cec-skip {
  font-size:12px; color:var(--subtle); margin-top:10px;
  cursor:pointer; background:none; border:none;
  font-family:inherit; display:block;
}
.cec-skip:hover { color:var(--muted); }

/* ══════════════════════════════════════════
   DECLARATIONS SCREEN
══════════════════════════════════════════ */
.decls-wrap { flex:1; padding:40px 48px; max-width:900px; margin:0 auto; width:100%; }

.decl-item {
  background:#fff; border:1.5px solid var(--border);
  border-radius:var(--radius); padding:24px;
  margin-bottom:14px; transition:all 0.2s;
  position:relative;
}
.decl-item:hover { box-shadow:var(--shadow); }
.di-cat {
  font-size:12px; font-weight:700; letter-spacing:0.06em;
  text-transform:uppercase; color:var(--muted); margin-bottom:6px;
}
.di-title { font-size:18px; font-weight:700; color:var(--ink); margin-bottom:10px; }
.di-text {
  font-size:16px; color:var(--ink2); line-height:1.65;
  font-style:italic; margin-bottom:12px;
}
.di-footer { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
.di-date { font-size:12px; color:var(--subtle); }
.di-stage-tag {
  font-size:11px; font-weight:600; color:var(--muted);
  background:var(--surface); border:1px solid var(--border);
  padding:2px 8px; border-radius:100px;
}
.di-attempt-num { font-size:11px; color:var(--subtle); }
.di-partners {
  font-size:11px; font-weight:600; color:#4a6b1a;
  background:var(--lime-bg); padding:2px 8px; border-radius:100px;
  margin-left:auto;
}

.empty-decls {
  text-align:center; padding:80px 24px;
}
.empty-decls-title { font-size:22px; font-weight:700; color:var(--ink); margin-bottom:8px; }
.empty-decls-sub { font-size:15px; color:var(--muted); }

/* ══════════════════════════════════════════
   PROGRESS SCREEN
══════════════════════════════════════════ */
.progress-wrap { flex:1; padding:40px 48px; max-width:1000px; margin:0 auto; width:100%; }

.progress-hero {
  background:var(--ink); border-radius:20px;
  padding:36px 40px; margin-bottom:32px;
  display:grid; grid-template-columns:1fr 1fr 1fr; gap:32px;
}
.ph-stat { text-align:center; }
.ph-num {
  font-size:48px; font-weight:800; color:var(--lime);
  line-height:1; margin-bottom:6px; letter-spacing:-1px;
}
.ph-label { font-size:12px; font-weight:600; color:rgba(255,255,255,0.5); letter-spacing:0.06em; text-transform:uppercase; }

.progress-section-title {
  font-size:12px; font-weight:700; letter-spacing:0.1em;
  text-transform:uppercase; color:var(--subtle);
  margin-bottom:16px; display:flex; align-items:center; gap:10px;
}
.progress-section-title::after { content:''; flex:1; height:1px; background:var(--border); }

.prog-cat-grid {
  display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:12px; margin-bottom:40px;
}
.prog-cat-item {
  background:#fff; border:1.5px solid var(--border);
  border-radius:12px; padding:18px;
}
.pci-emoji { font-size:20px; margin-bottom:8px; display:block; }
.pci-name { font-size:14px; font-weight:700; color:var(--ink); margin-bottom:4px; }
.pci-count { font-size:12px; color:var(--muted); margin-bottom:10px; }
.pci-bar {
  height:3px; background:var(--border);
  border-radius:2px; overflow:hidden;
}
.pci-bar-fill {
  height:100%; background:var(--lime);
  border-radius:2px; transition:width 0.5s;
}
.pci-complete { color:var(--lime); font-size:12px; font-weight:700; margin-top:6px; }

.timeline-list { display:flex; flex-direction:column; gap:10px; margin-bottom:40px; }
.timeline-item {
  background:#fff; border:1.5px solid var(--border);
  border-radius:12px; padding:16px 20px;
  display:flex; align-items:center; gap:16px;
}
.timeline-item-icon {
  width:36px; height:36px; border-radius:9px;
  background:var(--lime-bg); border:1px solid #c8e87a;
  display:flex; align-items:center; justify-content:center;
  font-size:16px; flex-shrink:0;
}
.timeline-item-body { flex:1; min-width:0; }
.timeline-item-title { font-size:14px; font-weight:700; color:var(--ink); margin-bottom:2px; }
.timeline-item-sub { font-size:12px; color:var(--muted); }
.timeline-item-date { font-size:11px; color:var(--subtle); text-align:right; flex-shrink:0; }

/* ══════════════════════════════════════════
   COUPLE SYNC SCREEN
══════════════════════════════════════════ */
#screen-couple { background:#fff; }
.couple-wrap {
  flex:1; display:flex; flex-direction:column;
  align-items:center; padding:60px 24px;
  max-width:640px; margin:0 auto; width:100%;
}
.invite-code-box {
  background:var(--surface); border:2px dashed var(--border2);
  border-radius:16px; padding:32px; text-align:center;
  margin:24px 0; width:100%;
}
.invite-code-label {
  font-size:12px; font-weight:700; letter-spacing:0.1em;
  text-transform:uppercase; color:var(--muted); margin-bottom:16px;
}
.invite-code {
  font-size:40px; font-weight:800; letter-spacing:8px;
  color:var(--ink); font-variant-numeric:tabular-nums;
  margin-bottom:14px;
}
.invite-code-expiry { font-size:12px; color:var(--subtle); margin-bottom:20px; }
.invite-copy-btn {
  background:var(--ink); color:#fff; border:none;
  font-family:inherit; font-size:14px; font-weight:600;
  padding:12px 28px; border-radius:9px; cursor:pointer;
  transition:all 0.2s;
}
.invite-copy-btn:hover { background:var(--ink2); }

.partner-list { width:100%; margin-top:20px; }
.partner-row {
  background:#fff; border:1.5px solid var(--border);
  border-radius:var(--radius); padding:18px 22px;
  display:flex; align-items:center; gap:14px;
  margin-bottom:10px;
}
.partner-avatar {
  width:40px; height:40px; border-radius:50%;
  background:var(--ink); color:#fff;
  display:flex; align-items:center; justify-content:center;
  font-size:16px; font-weight:700; flex-shrink:0;
}
.partner-avatar.partner-b { background:#4a8aff; }
.partner-info { flex:1; }
.partner-name { font-size:15px; font-weight:700; color:var(--ink); }
.partner-email { font-size:12px; color:var(--muted); margin-top:1px; }
.partner-status-tag {
  font-size:11px; font-weight:600; padding:3px 9px; border-radius:100px;
}

.enter-code-section { width:100%; margin-top:28px; }
.enter-code-title { font-size:15px; font-weight:700; margin-bottom:14px; }
.enter-code-row { display:flex; gap:10px; }
.enter-code-input {
  flex:1; font-family:inherit; font-size:18px; font-weight:700;
  letter-spacing:4px; text-transform:uppercase;
  color:var(--ink); background:var(--surface);
  border:1.5px solid var(--border); border-radius:10px;
  padding:13px 16px; outline:none; text-align:center;
  transition:border-color 0.2s;
}
.enter-code-input:focus { border-color:var(--lime); }
.enter-code-btn {
  background:var(--ink); color:#fff; border:none;
  font-family:inherit; font-size:14px; font-weight:600;
  padding:13px 22px; border-radius:10px; cursor:pointer;
  transition:all 0.2s;
}
.enter-code-btn:hover { background:var(--ink2); }

/* ══════════════════════════════════════════
   PROFILE SCREEN
══════════════════════════════════════════ */
#screen-profile { background:var(--surface); }
.profile-wrap {
  flex:1; padding:40px 48px;
  max-width:680px; margin:0 auto; width:100%;
}
.profile-card {
  background:#fff; border:1.5px solid var(--border);
  border-radius:var(--radius); padding:28px; margin-bottom:20px;
}
.profile-section-title {
  font-size:12px; font-weight:700; letter-spacing:0.08em;
  text-transform:uppercase; color:var(--muted); margin-bottom:16px;
}
.profile-row {
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 0; border-bottom:1px solid var(--border);
}
.profile-row:last-child { border-bottom:none; }
.profile-row-label { font-size:14px; font-weight:600; color:var(--ink); }
.profile-row-value { font-size:14px; color:var(--muted); }
.profile-action-btn {
  background:none; border:1px solid var(--border);
  font-family:inherit; font-size:13px; font-weight:600;
  color:var(--muted); padding:7px 14px; border-radius:7px;
  cursor:pointer; transition:all 0.2s;
}
.profile-action-btn:hover { border-color:var(--ink); color:var(--ink); }
.profile-danger-btn {
  background:none; border:1px solid #ffd0d0;
  font-family:inherit; font-size:13px; font-weight:600;
  color:#cc4444; padding:7px 14px; border-radius:7px;
  cursor:pointer; transition:all 0.2s;
}
.profile-danger-btn:hover { background:#fff8f8; }
</style>
</head>
<body>

<!-- ══ LANDING ══ -->
<section class="screen active" id="screen-landing">
  <nav class="land-nav">
    <div class="land-logo"><div class="land-logo-dot"></div>OneAccord</div>
    <div class="land-nav-links">
      <button class="land-nav-link" onclick="document.querySelector('.land-section').scrollIntoView({behavior:'smooth'})">How it works</button>
      <button class="land-nav-link" onclick="document.querySelector('.how-section').scrollIntoView({behavior:'smooth'})">The sessions</button>
    </div>
    <button class="nav-login-link" onclick="showAuthScreen('login')">Sign in</button>
    <button class="nav-cta" onclick="showScreen('stage')">Begin →</button>
  </nav>
  <div class="land-hero">
    <div>
      <div class="hero-badge"><div class="hero-badge-dot"></div> V2 — Couple Sync + Progress Tracking</div>
      <h1 class="hero-h1">Two people.<br><em>One accord.</em><br>Every conversation.</h1>
      <p class="hero-sub">Guided sessions that build shared conviction. From who you are to where you're going — together.</p>
      <div class="hero-btns">
        <button class="btn-dark" onclick="showScreen('stage')">Begin Your Sessions →</button>
        <button class="btn-outline" onclick="showAuthScreen('login')">Sign in</button>
      </div>
    </div>
    <div class="hero-visual">
      <div class="hero-card">
        <div class="hero-card-title">Your Session Library</div>
        <div class="session-preview-items">
          <div class="spi">
            <span class="spi-emoji">✝️</span>
            <div class="spi-text">
              <div class="spi-name">How We Worship</div>
              <div class="spi-sub">Faith & Spiritual Growth</div>
            </div>
            <div class="spi-badge">✓ Done</div>
          </div>
          <div class="spi">
            <span class="spi-emoji">⚖️</span>
            <div class="spi-text">
              <div class="spi-name">How We Fight</div>
              <div class="spi-sub">Conflict</div>
            </div>
            <div class="spi-badge-amber">⏳ Your turn</div>
          </div>
          <div class="spi">
            <span class="spi-emoji">💰</span>
            <div class="spi-text">
              <div class="spi-name">How We Spend</div>
              <div class="spi-sub">Money</div>
            </div>
            <div class="spi-badge-gray">Not started</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="trust-bar">
    <span class="trust-label">Built for</span>
    <div class="trust-items">
      <div class="trust-item"><span class="trust-check">✓</span> Christian couples</div>
      <div class="trust-item"><span class="trust-check">✓</span> Deep & Flashcard modes</div>
      <div class="trust-item"><span class="trust-check">✓</span> Async Couple Sync</div>
      <div class="trust-item"><span class="trust-check">✓</span> Growth history</div>
    </div>
  </div>
  <div class="land-section">
    <div class="section-label">What's new in V2</div>
    <h2 class="section-h2">Four pillars that go<br>deeper than ever.</h2>
    <p class="section-sub">Identity, Couple Sync, Progress Tracking, and Growth History — built so this platform is worth returning to for years.</p>
    <div class="feature-grid">
      <div class="feat-card">
        <div class="feat-icon">🔐</div>
        <div class="feat-title">Identity & Email</div>
        <div class="feat-desc">Magic link sign-in — no password. Your progress, declarations, and history persist across every device and session.</div>
      </div>
      <div class="feat-card">
        <div class="feat-icon">🔗</div>
        <div class="feat-title">Couple Sync</div>
        <div class="feat-desc">Two accounts, one shared space. Engage sessions independently on your own devices and co-author your declarations.</div>
      </div>
      <div class="feat-card">
        <div class="feat-icon">📈</div>
        <div class="feat-title">Progress Tracking</div>
        <div class="feat-desc">A Progress tab shows your journey across all 10 categories — what you've done, what's next, and your shared archive.</div>
      </div>
      <div class="feat-card">
        <div class="feat-icon">📖</div>
        <div class="feat-title">Growth History</div>
        <div class="feat-desc">Revisit any session and see your declarations side by side across attempts — visible proof of how you've grown together.</div>
      </div>
      <div class="feat-card">
        <div class="feat-icon">🔒</div>
        <div class="feat-title">Privacy by Design</div>
        <div class="feat-desc">My Story reflections are yours alone. Your Story answers are shared with your partner only after you submit. Always.</div>
      </div>
      <div class="feat-card">
        <div class="feat-icon">⚡</div>
        <div class="feat-title">Do Again</div>
        <div class="feat-desc">Completed a session as an engaged couple? Come back as a married couple. Every attempt is preserved, never overwritten.</div>
      </div>
    </div>
  </div>
  <div class="how-section">
    <div class="how-inner">
      <div class="section-label">How it works</div>
      <h2 class="section-h2">From two stories<br>to one conviction.</h2>
      <p class="section-sub">Each session moves through a structured flow — designed to surface, share, and seal what you believe together.</p>
      <div class="how-steps">
        <div class="how-step">
          <div class="how-step-num">01</div>
          <div class="how-step-title">My Story</div>
          <div class="how-step-desc">Private reflection on your own background, fears, and values. You write first — alone — then share.</div>
        </div>
        <div class="how-step">
          <div class="how-step-num">02</div>
          <div class="how-step-title">Your Story</div>
          <div class="how-step-desc">Your observations and understanding of your partner. Visible to them only after you submit.</div>
        </div>
        <div class="how-step">
          <div class="how-step-num">03</div>
          <div class="how-step-title">Find Our Middle</div>
          <div class="how-step-desc">From two perspectives to one shared position. You discuss, discover, and write it together.</div>
        </div>
        <div class="how-step">
          <div class="how-step-num">04</div>
          <div class="how-step-title">Our Declaration</div>
          <div class="how-step-desc">Seal your conviction. A permanent, dated record of what you agree on — the foundation of your shared language.</div>
        </div>
        <div class="how-step">
          <div class="how-step-num">05</div>
          <div class="how-step-title">Couple Sync</div>
          <div class="how-step-desc">Each partner engages on their own device. When both are done, seal the declaration together.</div>
        </div>
        <div class="how-step">
          <div class="how-step-num">06</div>
          <div class="how-step-title">Come Back</div>
          <div class="how-step-desc">Revisit sessions as your relationship grows. See how your declarations evolve across attempts and stages.</div>
        </div>
      </div>
    </div>
  </div>
  <div class="cta-section">
    <div class="section-label">Get started</div>
    <h2 class="section-h2">Every conversation counts.</h2>
    <p class="section-sub">Start with Session Zero — no email required. You can save your progress at any time.</p>
    <div class="cta-btns">
      <button class="btn-dark" onclick="showScreen('stage')">Begin Your Sessions →</button>
      <button class="btn-outline" onclick="showAuthScreen('login')">Sign in to continue</button>
    </div>
  </div>
  <footer class="land-footer">
    <div class="footer-logo"><div class="land-logo-dot"></div>OneAccord</div>
    <div class="footer-copy">Two people. One accord. Every conversation counts.</div>
  </footer>
</section>

<!-- ══ AUTH — EMAIL ENTRY ══ -->
<section class="screen" id="screen-auth">
  <div class="auth-wrap">
    <div class="auth-box">
      <div class="auth-logo"><div class="auth-logo-dot"></div>OneAccord</div>
      <h2 class="auth-h2" id="auth-h2">Welcome back.</h2>
      <p class="auth-sub" id="auth-sub">Enter your email to sign in — no password needed. We'll send you a 6-digit code.</p>
      <label class="auth-label">Email address</label>
      <input class="auth-input" type="email" id="auth-email-input" placeholder="you@example.com" onkeydown="if(event.key==='Enter')sendOTP()">
      <button class="auth-btn" onclick="sendOTP()">Send Code →</button>
      <p class="auth-skip">No account yet? <button class="auth-skip-link" onclick="showScreen('stage')">Start without one</button></p>
    </div>
  </div>
</section>

<!-- ══ AUTH — OTP ENTRY ══ -->
<section class="screen" id="screen-otp">
  <div class="auth-wrap">
    <div class="auth-box">
      <div class="auth-logo"><div class="auth-logo-dot"></div>OneAccord</div>
      <h2 class="auth-h2">Check your email.</h2>
      <p class="auth-sub">We sent a 6-digit code to:</p>
      <div class="auth-email-shown" id="otp-email-shown">—</div>
      <label class="auth-label">Enter code</label>
      <div class="otp-inputs">
        <input class="otp-digit" maxlength="1" id="otp-0" oninput="otpInput(0)" onkeydown="otpKey(event,0)">
        <input class="otp-digit" maxlength="1" id="otp-1" oninput="otpInput(1)" onkeydown="otpKey(event,1)">
        <input class="otp-digit" maxlength="1" id="otp-2" oninput="otpInput(2)" onkeydown="otpKey(event,2)">
        <input class="otp-digit" maxlength="1" id="otp-3" oninput="otpInput(3)" onkeydown="otpKey(event,3)">
        <input class="otp-digit" maxlength="1" id="otp-4" oninput="otpInput(4)" onkeydown="otpKey(event,4)">
        <input class="otp-digit" maxlength="1" id="otp-5" oninput="otpInput(5)" onkeydown="otpKey(event,5)">
      </div>
      <button class="auth-btn" onclick="verifyOTP()">Verify & Sign In →</button>
      <p class="auth-resend">Didn't get it? <button class="auth-resend-link" onclick="sendOTP()">Send again</button></p>
      <p class="auth-skip" style="margin-top:8px;"><button class="auth-skip-link" onclick="showScreen('auth')">← Change email</button></p>
    </div>
  </div>
</section>

<!-- ══ EMAIL CAPTURE MODAL ══ -->
<div class="modal-overlay" id="email-modal">
  <div class="modal-box">
    <h3 class="modal-h3" id="modal-title">Save your progress.</h3>
    <p class="modal-sub" id="modal-sub">Your declaration has been written. Save it permanently — this is the first entry in your shared archive.</p>
    <input class="modal-input" type="email" id="modal-email-input" placeholder="your@email.com" onkeydown="if(event.key==='Enter')modalSaveEmail()">
    <button class="modal-btn" onclick="modalSaveEmail()">Save with my email →</button>
    <button class="modal-skip" id="modal-skip-btn" onclick="closeEmailModal()">Skip — I understand I may lose this</button>
  </div>
</div>

<!-- ══ STAGE SELECTOR ══ -->
<section class="screen" id="screen-stage">
  <nav class="top-nav">
    <a class="nav-logo" onclick="showScreen('landing')"><div class="nav-logo-dot"></div>OneAccord</a>
    <div class="nav-user" id="stage-nav-user" style="display:none">
      <span class="nav-user-name" id="stage-nav-name"></span>
      <button class="nav-profile-btn" id="stage-nav-initial" onclick="showScreen('profile')"></button>
    </div>
  </nav>
  <div class="page-body">
    <div class="page-eyebrow">Getting started</div>
    <h1 class="page-h1">Where are you<br>in your relationship?</h1>
    <p class="page-sub">Your stage shapes your recommended session path. You can always change this later.</p>
    <div class="stage-cards">
      <div class="stage-card" onclick="selectStage('dating',this)">
        <span class="stage-card-emoji">🌱</span>
        <div class="stage-card-name">Dating</div>
        <div class="stage-card-hint">Exploring, building something intentional.</div>
      </div>
      <div class="stage-card" onclick="selectStage('engaged',this)">
        <span class="stage-card-emoji">💍</span>
        <div class="stage-card-name">Engaged</div>
        <div class="stage-card-hint">Preparing for the covenant of marriage.</div>
      </div>
      <div class="stage-card" onclick="selectStage('married',this)">
        <span class="stage-card-emoji">🕊️</span>
        <div class="stage-card-name">Married</div>
        <div class="stage-card-hint">Going deeper, building a lasting foundation.</div>
      </div>
    </div>
    <button class="btn-dark" id="stage-cta" style="opacity:0.35;pointer-events:none" onclick="goToZero()">Begin Session Zero →</button>
  </div>
</section>

<!-- ══ SESSION ZERO ══ -->
<section class="screen" id="screen-zero">
  <nav class="top-nav">
    <a class="nav-logo" onclick="showScreen('landing')"><div class="nav-logo-dot"></div>OneAccord</a>
    <button class="nav-back" onclick="showScreen('stage')">← Back</button>
  </nav>
  <div class="zero-body">
    <div class="progress-row" id="zero-dots">
      <div class="pdot active" id="pd1"></div>
      <div class="pdot" id="pd2"></div>
      <div class="pdot" id="pd3"></div>
      <div class="pdot" id="pd4"></div>
    </div>
    <!-- Step 1: Welcome -->
    <div class="zero-step active" id="zs-1">
      <div class="page-eyebrow">Session Zero</div>
      <h1 class="page-h1">Before you begin,<br>understand the structure.</h1>
      <p class="page-sub">Every session moves through four phases. Here's how it works.</p>
      <div class="how-grid">
        <div class="how-card">
          <div class="how-num">1</div>
          <div class="how-label">My Story</div>
          <div class="how-desc">Private reflection on your own experience. Yours alone.</div>
        </div>
        <div class="how-card">
          <div class="how-num">2</div>
          <div class="how-label">Your Story</div>
          <div class="how-desc">What you observe and understand about your partner.</div>
        </div>
        <div class="how-card">
          <div class="how-num">3</div>
          <div class="how-label">Find Our Middle</div>
          <div class="how-desc">From two views to one shared position.</div>
        </div>
      </div>
      <button class="btn-dark" onclick="zeroNext(2)">Continue →</button>
    </div>
    <!-- Step 2: My Story question -->
    <div class="zero-step" id="zs-2">
      <div class="page-eyebrow">My Story — Your turn first</div>
      <h1 class="page-h1">Reflect before you share.</h1>
      <div class="z-question">
        <p class="z-q-text">What is the one thing you most want this relationship to be defined by — above everything else?</p>
        <textarea class="z-input" id="zero-q1" placeholder="Write your reflection here — this is just for you…"></textarea>
      </div>
      <button class="btn-dark" onclick="zeroNext(3)" style="width:100%">Continue →</button>
    </div>
    <!-- Step 3: Your Story question -->
    <div class="zero-step" id="zs-3">
      <div class="page-eyebrow">Your Story — Now understand them</div>
      <h1 class="page-h1">What do you know about<br>your partner?</h1>
      <div class="z-question">
        <p class="z-q-text">What do you think your partner most wants this relationship to be defined by?</p>
        <textarea class="z-input" id="zero-q2" placeholder="Your observation of who they are…"></textarea>
      </div>
      <button class="btn-dark" onclick="zeroNext(4)" style="width:100%">Generate My First Declaration →</button>
    </div>
    <!-- Step 4: Declaration -->
    <div class="zero-step" id="zs-4">
      <div class="page-eyebrow">Your First Declaration</div>
      <h1 class="page-h1" style="text-align:center">Here it is.</h1>
      <div class="decl-success">
        <div class="ds-label">✦ Your Declaration</div>
        <div class="ds-text" id="zero-decl-text">"We agree that this relationship should be defined by faith, honesty, and the willingness to always choose each other — even when it's hard."</div>
      </div>
      <p class="page-sub" style="text-align:center;margin-top:12px;">This is what a declaration looks like. Every session ends with one — written in your own words, sealed permanently into your shared archive.</p>
      <div class="email-capture-soft" id="zero-email-capture">
        <div class="ecs-title">Want to save this and track your progress?</div>
        <div class="ecs-sub">Enter your email to preserve your declarations across sessions and devices — no password, ever.</div>
        <div class="ecs-row">
          <input class="ecs-input" type="email" id="zero-email" placeholder="your@email.com">
          <button class="ecs-btn" onclick="saveEmailFromZero()">Save My Progress</button>
        </div>
        <button class="ecs-skip" onclick="skipZeroEmail()">Skip for now</button>
      </div>
      <button class="btn-dark" id="zero-library-btn" style="width:100%;display:none;margin-top:20px" onclick="enterLibrary()">Enter Session Library →</button>
    </div>
  </div>
</section>

<!-- ══ LIBRARY ══ -->
<section class="screen" id="screen-library">
  <nav class="top-nav">
    <a class="nav-logo" onclick="showScreen('landing')"><div class="nav-logo-dot"></div>OneAccord</a>
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showLibTab('library')">Sessions</button>
      <button class="nav-tab" onclick="showLibTab('declarations')">Declarations</button>
      <button class="nav-tab" onclick="showLibTab('progress')">Progress</button>
    </div>
    <div class="nav-user" id="lib-nav-user">
      <span class="nav-user-name" id="lib-nav-name"></span>
      <div class="nav-partner-badge" id="lib-partner-badge" style="display:none">
        <div class="nav-partner-dot"></div><span id="lib-partner-name">Partner</span>
      </div>
      <button class="nav-profile-btn" id="lib-nav-initial" onclick="showScreen('profile')"></button>
    </div>
  </nav>
  <div class="library-wrap">
    <div class="lib-top">
      <div>
        <div class="stage-pill" id="stage-pill">💍 Engaged</div>
      </div>
    </div>

    <!-- Couple sync banner/CTA -->
    <div class="couple-banner" id="couple-connected-banner" style="display:none">
      <div class="couple-banner-icon">🔗</div>
      <div class="couple-banner-text">
        <div class="couple-banner-title" id="couple-banner-title">Connected with partner</div>
        <div class="couple-banner-sub" id="couple-banner-sub">Couple Space active — sessions now track both of you.</div>
      </div>
      <button class="couple-banner-btn" onclick="showScreen('couple')">Manage</button>
    </div>
    <div class="connect-cta" id="connect-partner-cta" onclick="showScreen('couple')" style="display:none">
      <div class="connect-cta-icon">🔗</div>
      <div class="connect-cta-text">
        <div class="connect-cta-title">Connect with your partner</div>
        <div class="connect-cta-sub">Link two accounts so you can both engage sessions independently and co-author declarations.</div>
      </div>
      <div class="connect-cta-arrow">→</div>
    </div>

    <div class="rec-section">
      <div class="rec-heading">Recommended path for your stage</div>
      <div class="rec-path" id="rec-path"></div>
    </div>
    <div class="all-cats-heading">All categories</div>
    <div class="cat-grid" id="cat-grid"></div>
  </div>
</section>

<!-- ══ PICKER ══ -->
<section class="screen" id="screen-picker">
  <nav class="top-nav">
    <a class="nav-logo" onclick="showScreen('landing')"><div class="nav-logo-dot"></div>OneAccord</a>
    <span id="pick-cat-label" style="font-size:13px;font-weight:600;color:var(--muted)"></span>
    <button class="nav-back" onclick="enterLibrary()">← Library</button>
  </nav>
  <div class="picker-wrap">
    <div class="page-eyebrow" id="pick-title">Choose a Session</div>
    <h1 class="page-h1" id="pick-cat-name" style="text-align:center;margin-bottom:8px"></h1>
    <p class="page-sub" id="pick-desc" style="text-align:center"></p>

    <!-- Previous attempts panel (shown when a completed session is selected) -->
    <div id="attempts-panel-wrap" style="width:100%;display:none"></div>

    <div class="session-list" id="sess-list"></div>

    <div class="mode-label">Choose your mode</div>
    <div class="mode-grid">
      <div class="mode-card" id="mode-deep" onclick="selectMode('deep',this)">
        <div class="mode-icon">📖</div>
        <div class="mode-name">Deep Session</div>
        <div class="mode-time">45–60 min</div>
        <div class="mode-desc">Full structured conversation — prayer, reflection, finding your middle, and declaring together.</div>
      </div>
      <div class="mode-card" id="mode-flash" onclick="selectMode('flash',this)">
        <div class="mode-icon">⚡</div>
        <div class="mode-name">Flashcards</div>
        <div class="mode-time">15–20 min</div>
        <div class="mode-desc">Quick-fire questions to spark conversation. Best for revisiting or when time is short.</div>
      </div>
    </div>
    <button class="btn-dark" id="begin-btn" style="width:100%;opacity:0.35;pointer-events:none" onclick="beginSession()">Begin Session →</button>
  </div>
</section>

<!-- ══ FLASHCARD MODE ══ -->
<section class="screen" id="screen-flash">
  <nav class="top-nav">
    <a class="nav-logo" onclick="showScreen('landing')"><div class="nav-logo-dot"></div>OneAccord</a>
    <button class="nav-back" onclick="openCat(S.cat)">← Back</button>
  </nav>
  <div class="flash-wrap">
    <div class="flash-progress" id="flash-progress"></div>
    <div class="flash-counter" id="flash-counter">Card 1 of 8</div>
    <div class="flashcard-scene" onclick="flipCard()">
      <div class="flashcard" id="flashcard">
        <div class="fc-face fc-front">
          <div class="fc-tag">Question</div>
          <div class="fc-question" id="fc-question">Loading...</div>
          <div class="fc-hint">Tap to flip</div>
        </div>
        <div class="fc-face fc-back">
          <div class="fc-tag">Talk about it</div>
          <div class="fc-answer-label">Share with your partner:</div>
          <div class="fc-answer fc-prompt" id="fc-prompt"></div>
          <div class="fc-prompt">Listen before you respond.</div>
        </div>
      </div>
    </div>
    <div class="flash-controls">
      <button class="flash-btn" onclick="flashPrev()">← Prev</button>
      <button class="flash-btn flash-btn-next" id="flash-next-btn" onclick="flashNext()">Next Card →</button>
    </div>

    <!-- Declaration section (shown at end) -->
    <div id="flash-decl-section" style="display:none;width:100%;margin-top:24px">
      <div class="flash-decl-wrap">
        <div class="flash-decl-preamble">✦ Write Your Declaration</div>
        <p style="font-size:14px;color:rgba(255,255,255,0.55);margin-bottom:14px;line-height:1.6;">Based on your conversation — what do you agree on?</p>
        <span style="font-size:22px;font-weight:700;color:var(--lime);font-style:italic;display:block;margin-bottom:8px;">We agree that...</span>
        <textarea class="flash-decl-field" id="flash-decl-input" placeholder="…write your shared declaration here."></textarea>
        <p class="flash-decl-hint">Take your time. This is sealed permanently.</p>
      </div>
      <button class="btn-dark" style="width:100%;margin-top:16px" onclick="saveFlashDeclaration()">Seal This Declaration ✓</button>
    </div>
  </div>
</section>

<!-- ══ DEEP SESSION ══ -->
<section class="screen" id="screen-session">
  <nav class="top-nav">
    <a class="nav-logo" onclick="showScreen('landing')"><div class="nav-logo-dot"></div>OneAccord</a>
    <span class="sess-cat" id="sess-cat-label"></span>
    <button class="nav-back" onclick="openCat(S.cat)">← Exit</button>
  </nav>
  <div class="sess-topbar">
    <div class="sess-prog" id="sess-prog"></div>
    <div class="sess-step-label" id="sess-step-label"></div>
  </div>
  <div class="sess-body" id="sess-body"></div>
</section>

<!-- ══ CONFIRM ══ -->
<section class="screen" id="screen-confirm">
  <nav class="top-nav">
    <a class="nav-logo" onclick="showScreen('landing')"><div class="nav-logo-dot"></div>OneAccord</a>
  </nav>
  <div class="confirm-body">
    <div class="confirm-icon">✦</div>
    <h2 class="confirm-h2">Declaration sealed.</h2>
    <p class="confirm-sub">This is now part of your permanent shared archive. Return to it, reflect on it, build on it.</p>
    <div class="confirm-decl-card">
      <div class="confirm-decl-label">✦ Your Declaration</div>
      <div class="confirm-decl-text" id="confirm-text"></div>
    </div>

    <!-- Medium-strength email capture (if not logged in) -->
    <div class="confirm-email-capture" id="confirm-email-capture" style="display:none">
      <div class="cec-title">Your declaration has been written.</div>
      <div class="cec-sub">Save it permanently — this is the first entry in your shared archive. Declarations for anonymous users are stored locally only.</div>
      <div class="cec-row">
        <input class="cec-input" type="email" id="confirm-email-input" placeholder="your@email.com">
        <button class="cec-btn" onclick="saveEmailFromConfirm()">Save →</button>
      </div>
      <button class="cec-skip" onclick="document.getElementById('confirm-email-capture').style.display='none'">Skip — I understand I may lose this</button>
    </div>

    <div class="confirm-btns">
      <button class="btn-dark" onclick="enterLibrary()">Back to Library</button>
      <button class="btn-outline" onclick="showLibTab('declarations')">View All Declarations</button>
    </div>
  </div>
</section>

<!-- ══ DECLARATIONS ══ -->
<section class="screen" id="screen-declarations">
  <nav class="top-nav">
    <a class="nav-logo" onclick="showScreen('landing')"><div class="nav-logo-dot"></div>OneAccord</a>
    <div class="nav-tabs">
      <button class="nav-tab" onclick="showLibTab('library')">Sessions</button>
      <button class="nav-tab active" onclick="showLibTab('declarations')">Declarations</button>
      <button class="nav-tab" onclick="showLibTab('progress')">Progress</button>
    </div>
    <div class="nav-user">
      <button class="nav-profile-btn" id="decls-nav-initial" onclick="showScreen('profile')"></button>
    </div>
  </nav>
  <div class="decls-wrap">
    <div class="lib-top">
      <h2 style="font-size:24px;font-weight:800;letter-spacing:-0.5px;">Your Declarations</h2>
    </div>
    <div id="decls-list"></div>
  </div>
</section>

<!-- ══ PROGRESS ══ -->
<section class="screen" id="screen-progress">
  <nav class="top-nav">
    <a class="nav-logo" onclick="showScreen('landing')"><div class="nav-logo-dot"></div>OneAccord</a>
    <div class="nav-tabs">
      <button class="nav-tab" onclick="showLibTab('library')">Sessions</button>
      <button class="nav-tab" onclick="showLibTab('declarations')">Declarations</button>
      <button class="nav-tab active" onclick="showLibTab('progress')">Progress</button>
    </div>
    <div class="nav-user">
      <button class="nav-profile-btn" id="prog-nav-initial" onclick="showScreen('profile')"></button>
    </div>
  </nav>
  <div class="progress-wrap" id="progress-wrap"></div>
</section>

<!-- ══ COUPLE SYNC ══ -->
<section class="screen" id="screen-couple">
  <nav class="top-nav">
    <a class="nav-logo" onclick="showScreen('landing')"><div class="nav-logo-dot"></div>OneAccord</a>
    <span style="font-size:13px;font-weight:600;color:var(--muted)">Couple Space</span>
    <button class="nav-back" onclick="enterLibrary()">← Library</button>
  </nav>
  <div class="couple-wrap">
    <div class="page-eyebrow">Couple Sync</div>
    <h1 class="page-h1" style="text-align:center">Connect with your partner.</h1>
    <p class="page-sub" style="text-align:center">Link two OneAccord accounts into one shared Couple Space. Each partner uses their own device, their own account.</p>

    <div id="couple-content"></div>

    <!-- Enter someone else's code -->
    <div class="enter-code-section" id="enter-code-section">
      <div class="enter-code-title">Have an invite code from your partner?</div>
      <div class="enter-code-row">
        <input class="enter-code-input" type="text" id="enter-code-input" placeholder="ABC123" maxlength="6">
        <button class="enter-code-btn" onclick="acceptInviteCode()">Join →</button>
      </div>
    </div>
  </div>
</section>

<!-- ══ PROFILE ══ -->
<section class="screen" id="screen-profile">
  <nav class="top-nav">
    <a class="nav-logo" onclick="showScreen('landing')"><div class="nav-logo-dot"></div>OneAccord</a>
    <span style="font-size:13px;font-weight:600;color:var(--muted)">Profile</span>
    <button class="nav-back" onclick="enterLibrary()">← Library</button>
  </nav>
  <div class="profile-wrap" id="profile-wrap"></div>
</section>

<script>
// ══════════════════════════════════════════════════════════
//  STATE
// ══════════════════════════════════════════════════════════
const S = {
  stage: null,
  cat: null,
  session: null,
  mode: null,
  sections: [],
  secIdx: 0,
  flashIdx: 0,
  flashFlipped: false,
  flashDeclShowing: false,

  // V2 Identity
  email: localStorage.getItem('oa_email') || null,
  userName: localStorage.getItem('oa_name') || null,

  // V2 Couple Sync (simulated)
  partnerEmail: localStorage.getItem('oa_partner_email') || null,
  partnerName: localStorage.getItem('oa_partner_name') || null,
  coupleSpaceId: localStorage.getItem('oa_couple_space') || null,

  // V2 Declarations & Attempts
  declarations: JSON.parse(localStorage.getItem('oa_declarations')||'[]'),
  // attempts: [{id, sessionId, sessionTitle, category, categoryEmoji, mode, stage, declaration, date, dateMs, partners}]
  attempts: JSON.parse(localStorage.getItem('oa_attempts')||'[]'),

  // session completion keyed by sessionId
  completedSessions: JSON.parse(localStorage.getItem('oa_completed')||'{}'),

  // V2 email prompt: track which moment has been shown
  emailCaptureShown: +localStorage.getItem('oa_ecshown')||0,
};

function persistState() {
  localStorage.setItem('oa_declarations', JSON.stringify(S.declarations));
  localStorage.setItem('oa_attempts', JSON.stringify(S.attempts));
  localStorage.setItem('oa_completed', JSON.stringify(S.completedSessions));
  if(S.email) localStorage.setItem('oa_email', S.email);
  if(S.userName) localStorage.setItem('oa_name', S.userName);
  if(S.partnerEmail) localStorage.setItem('oa_partner_email', S.partnerEmail);
  if(S.partnerName) localStorage.setItem('oa_partner_name', S.partnerName);
  if(S.coupleSpaceId) localStorage.setItem('oa_couple_space', S.coupleSpaceId);
}

// ══════════════════════════════════════════════════════════
//  DATA
// ══════════════════════════════════════════════════════════
const CATS = [
  {
    key:'foundation', name:'Foundation', emoji:'🏛️', desc:'Who you are and why you are doing this together.',
    sessions:[
      { id:'f1', title:'Who We Are', sub:'Your individual stories and what shaped you.',
        why:`Every person arrives in a relationship carrying the weight and beauty of their history. The family you grew up in, the experiences that formed you, the wounds you still carry and the strengths you've built — all of these come with you.\n\nBefore you can build something together, you need to understand who each of you actually is. Not the version you present, but the real person shaped by a real story.\n\nThis session is an invitation to let your partner truly see you — and to truly see them.`,
        scripture:{text:'So then you are no longer strangers and aliens, but you are fellow citizens with the saints and members of the household of God.',ref:'Ephesians 2:19'},
        myStory:['What is one experience from your childhood that shaped how you relate to people you love?','What belief about yourself did you grow up carrying that still influences you today?','What do you most want your partner to understand about who you are and where you came from?'],
        yourStory:['What part of their upbringing do you think has shaped them the most?','What is a belief or value they hold that you want to understand more deeply?','What is one thing about their story that moves or inspires you?'],
        middle:['Where do your backgrounds differ the most?','Where do you already feel a natural alignment in your stories?','What tension might your different histories create?','What principle should guide how you hold each other\'s stories?','What do you want to commit to in how you handle each other\'s past?'],
        openPrayer:'Lord, give us the courage to be seen fully and the grace to fully see each other.',
        closePrayer:'Lord, thank you for the story you gave each of us. Help us to honour what has shaped the person we love.',
        flashCards:['What is one experience from childhood that still shapes how you love?','What belief about yourself did you carry into this relationship?','What do you wish your partner understood more fully about your story?','Where do our backgrounds create beautiful difference between us?','What is one wound from your past you\'re still learning to carry?','What strength did your upbringing give you that you\'re proud of?','What does "home" mean to you — based on where you came from?','What part of your partner\'s story moves you the most?']
      },
      { id:'f2', title:'Why We\'re Doing This', sub:'Clarifying your shared intent and vision for this relationship.',
        why:`A relationship without a shared sense of purpose drifts. Two people can be deeply in love and still be heading in different directions because they've never articulated what they're building together.\n\nThis session asks a foundational question: Why are we doing this? Not just "because we love each other" — love is the fuel, but what's the destination?\n\nCouples who can answer this question together build on solid ground.`,
        scripture:{text:'Commit your way to the Lord; trust in him, and he will act.',ref:'Psalm 37:5'},
        myStory:['What is the deepest reason you are pursuing this relationship — beyond feelings?','What does a successful marriage look like to you in 10 years?','What are you most afraid of when you think about the future of this relationship?'],
        yourStory:['What do you think motivates your partner most deeply in this relationship?','What vision do you sense your partner has for the life you could build?','What fear do you think your partner carries that they may not always voice?'],
        middle:['Where does your vision for this relationship overlap?','Where do you notice differences in what you each hope for?','What is the tension between your individual hopes and a shared direction?','What principle should guide your shared purpose as a couple?','What one commitment can you make today about the kind of relationship you are building?'],
        openPrayer:'Lord, align our hearts with your purpose for this relationship. Let us build something that glorifies you.',
        closePrayer:'Lord, seal the vision you have placed in us. Let our love be purposeful, not accidental.',
        flashCards:['Why are you really in this relationship — beyond feelings?','What does "a successful marriage" mean to you?','What is the life you imagine building together in 20 years?','What are you most afraid of when you think about the future?','What is one shared dream you haven\'t said out loud yet?','What would make you feel like this relationship was everything it could be?','What do you think God has for you two together?','What legacy do you want to leave as a couple?']
      }
    ]
  },
  {
    key:'faith', name:'Faith & Spiritual Growth', emoji:'✝️', desc:'How faith shapes your individual lives and your life together.',
    sessions:[
      { id:'fa1', title:'How We Worship', sub:'Your faith backgrounds and what spiritual life looks like together.',
        why:`Two Christians can hold the same faith in very different ways. One grew up in a liturgical tradition. Another in a charismatic environment. One prays aloud comfortably, another prays inwardly.\n\nNone of these differences are disqualifying — but they can create real friction if left unaddressed. This session invites you to share honestly about your faith life: not the version that sounds most mature, but the actual reality of how you relate to God and what you need spiritually.`,
        scripture:{text:'And let us consider how to stir up one another to love and good works, not neglecting to meet together.',ref:'Hebrews 10:24–25'},
        myStory:['What did your faith look like growing up — and how has it changed?','What does your personal relationship with God actually look like day to day right now?','What do you need from your partner when it comes to your spiritual life?'],
        yourStory:['How would you describe your partner\'s relationship with God based on what you\'ve observed?','What aspect of their faith do you find most inspiring?','What do you think your partner might need spiritually that they may not always ask for?'],
        middle:['Where do your faith expressions and traditions differ?','Where do you feel spiritually united already?','What could become a point of tension if not addressed?','What principle should guide how you lead each other spiritually?','What would it look like to build a shared spiritual life that honours both of you?'],
        openPrayer:'Lord, be the foundation of everything we build. Make our faith something we share, not just something we carry individually.',
        closePrayer:'Lord, draw us both closer to you. Let our spiritual life together be a source of strength, not pressure.',
        flashCards:['What does your faith actually look like on an ordinary Tuesday?','What spiritual habit do you wish you were more consistent with?','What does worship mean to you — beyond Sunday?','What do you need from your partner spiritually?','What part of your partner\'s faith life inspires you most?','Where do your spiritual traditions or expressions differ?','What would a spiritually healthy week look like for both of you?','What is one thing you want to build into your spiritual life together?']
      },
      { id:'fa2', title:'Leading Our Home Spiritually', sub:'Roles, responsibility and what a spiritually healthy home looks like.',
        why:`A lot of couples assume the question of spiritual leadership is simple. It rarely is. Questions of who leads, how leadership is defined, what happens when one partner is spiritually stronger in a season — these are real conversations that need to happen early.\n\nThis session is not about imposing a framework. It is about understanding each other's convictions and expectations around spiritual leadership so you can build something you both own.`,
        scripture:{text:'But as for me and my house, we will serve the Lord.',ref:'Joshua 24:15'},
        myStory:['What is your understanding of spiritual leadership in a marriage — and where did that view come from?','What does a spiritually healthy home look like to you practically?','What are you afraid of getting wrong when it comes to spiritual life at home?'],
        yourStory:['How do you think your partner understands their spiritual role in your relationship?','What spiritual habits or practices do you hope to build together?','Where might your different views on spiritual leadership create friction?'],
        middle:['Where do your expectations around spiritual leadership align?','Where do they differ?','What tension might arise if this isn\'t clarified?','What principle should govern how you lead spiritually in your home?','What specific practice can you commit to starting as a couple?'],
        openPrayer:'Lord, teach us how to lead each other to you. Give us humility about our own limitations.',
        closePrayer:'Lord, make our home a place of prayer, peace, and your presence. Help us to take that seriously together.',
        flashCards:['What does spiritual leadership in a marriage mean to you?','What would a spiritually thriving home feel like day to day?','How was prayer handled in the home you grew up in?','What spiritual practice do you most want to build into your home?','Where do you feel spiritually confident? Where do you feel inadequate?','What does it look like when one partner is in a spiritual dry season?','What role should the church play in your home life?','What one spiritual commitment can you make to your relationship this week?']
      }
    ]
  },
  {
    key:'communication', name:'Communication', emoji:'💬', desc:'How you speak, listen, and understand each other.',
    sessions:[
      { id:'c1', title:'How We Talk', sub:'Communication styles and what makes you feel truly heard.',
        why:`Most couples believe they communicate well — until they're under pressure and discover they communicate very differently. One person processes out loud; the other needs time alone. One leads with feelings; the other with logic.\n\nNone of these styles are wrong. But they can feel wrong — even threatening — when you don't understand them. This session helps you learn each other's language before frustration does the teaching.`,
        scripture:{text:'Let every person be quick to hear, slow to speak, slow to anger.',ref:'James 1:19'},
        myStory:['How do you naturally process difficult emotions — outwardly or inwardly?','What makes you feel truly heard and understood in a conversation?','What communication habit in yourself do you know needs work?'],
        yourStory:['How does your partner seem to process things when something is difficult?','What does your partner do that makes you feel like they\'re really listening?','What do you think your partner needs from you in difficult conversations that you don\'t always give?'],
        middle:['Where do your communication styles differ most clearly?','Where do you already communicate naturally and well?','What pattern tends to break down your conversations?','What principle should guide how you communicate under pressure?','What one specific communication habit could you both commit to building?'],
        openPrayer:'Lord, help us to listen more than we speak, and to speak more carefully than we feel.',
        closePrayer:'Lord, make us people who build each other up with our words and who learn the language of the person we love.',
        flashCards:['Are you a process-out-loud or process-alone person?','What makes you feel like someone is really listening to you?','What do you do when you\'re overwhelmed that your partner may not understand?','What\'s a conversation habit you have that you know gets in the way?','What does your partner do that makes you feel completely heard?','When do you need space — and how do you signal that?','What does "a good conversation" feel like to you?','What would make you feel safer speaking honestly with your partner?']
      }
    ]
  },
  {
    key:'conflict', name:'Conflict', emoji:'⚖️', desc:'How you navigate disagreement, repair, and forgiveness.',
    sessions:[
      { id:'co1', title:'How We Fight', sub:'Your conflict patterns and what healthy disagreement looks like.',
        why:`Every couple fights. The question is not whether you'll have conflict — it's whether your conflict will build you or break you.\n\nWhat you learned about conflict growing up is with you right now. The way your parents handled disagreement — or didn't — shaped your instincts. This session surfaces that, so your past doesn't silently run your present.`,
        scripture:{text:'Be angry and do not sin; do not let the sun go down on your anger.',ref:'Ephesians 4:26'},
        myStory:['What did conflict look like in your home growing up?','What is your instinctive response when you feel hurt — pursue, withdraw, or escalate?','What do you need from your partner in the middle of a disagreement to feel safe?'],
        yourStory:['How does your partner tend to respond when they\'re in conflict?','What triggers in them have you already noticed?','What do you think your partner needs from you when things are tense?'],
        middle:['Where do your conflict styles clash?','Where do you actually handle disagreement well together?','What pattern do you want to intentionally break?','What principle should govern how you fight — what is always off limits?','What agreement can you make now about how you will handle your next real conflict?'],
        openPrayer:'Lord, make us quick to reconcile and slow to wound. Teach us to fight for the relationship, not against each other.',
        closePrayer:'Lord, let our conflicts produce growth, not damage. Help us to honour each other even when we disagree.',
        flashCards:['What did conflict look like in your home growing up?','Do you tend to pursue, withdraw, or escalate when you\'re hurt?','What is never okay in a fight — a non-negotiable limit?','What do you need in order to feel safe during conflict?','What does your partner do that de-escalates tension for you?','What conflict habit from your past do you want to break?','What does "fighting fair" mean to you?','What helps you feel ready to repair after a hard conversation?']
      },
      { id:'co2', title:'Repair & Forgiveness', sub:'How you come back to each other and what forgiveness means in practice.',
        why:`How a couple repairs after conflict matters more than how they fight. Any two people can get into an argument. Very few have a clear, practised path back to each other.\n\nForgiveness in a marriage is not a feeling. It is a decision made over and over, often before the feeling catches up. This session helps you build a shared understanding of what repair looks like for you — before you need it.`,
        scripture:{text:'Be kind to one another, tenderhearted, forgiving one another, as God in Christ forgave you.',ref:'Ephesians 4:32'},
        myStory:['What does it cost you to apologise — and what makes it easier or harder?','How do you know when you\'ve truly forgiven someone?','What does repair look like for you? What do you need before you feel reconnected?'],
        yourStory:['How does your partner tend to apologise — and does it land for you?','What helps your partner feel forgiven and reconnected rather than just tolerated?','What does your partner need to fully move on from a hurt?'],
        middle:['Where do your repair styles differ?','Where do you already have instincts about what works for both of you?','What has gotten in the way of full repair in past conflicts?','What principle should govern how you seek and give forgiveness?','What specific repair commitment can you make — something you both agree to do after a conflict?'],
        openPrayer:'Lord, make forgiveness a reflex in this relationship. Remind us how much we have already been forgiven.',
        closePrayer:'Lord, help us to never let wounds become walls. Teach us how to come back to each other with humility and grace.',
        flashCards:['What makes it hard or easy for you to apologise?','What does a genuine apology look like to you?','How do you know you\'ve truly been forgiven — not just tolerated?','What do you need before you\'re ready to reconnect after conflict?','What has felt like repair in your relationship so far?','What wound from the past are you still carrying forward?','What does "letting it go" actually mean to you?','What one repair commitment could change how you come back to each other?']
      }
    ]
  },
  {
    key:'money', name:'Money', emoji:'💰', desc:'Your financial values, habits, and how you\'ll steward what God gives you.',
    sessions:[
      { id:'m1', title:'How We Spend', sub:'Your money personalities and the beliefs behind your financial decisions.',
        why:`Money is one of the most common sources of conflict in marriage — not because money is complicated, but because it is deeply personal. What you spend on, how much you save, what debt means to you — all of these behaviours are rooted in beliefs formed long before you met your partner.\n\nTwo people can both be responsible with money and still fight constantly about it — because they have different definitions of what "responsible" means. This session surfaces the beliefs beneath the behaviours.`,
        scripture:{text:'The plans of the diligent lead surely to abundance, but everyone who is hasty comes only to poverty.',ref:'Proverbs 21:5'},
        myStory:['What was the financial climate like in the home you grew up in?','Are you naturally a spender or a saver — and what emotion drives that?','What does financial security mean to you, and what does it feel like when you don\'t have it?'],
        yourStory:['How would you describe your partner\'s relationship with money?','What financial habit or value in your partner do you genuinely admire?','What financial tendency in your partner creates anxiety — even if you haven\'t said it out loud?'],
        middle:['Where do your money personalities differ most clearly?','Where do you already have natural financial alignment?','What financial tension could become a regular conflict point if not addressed?','What principle should govern how you make financial decisions together?','What is one specific financial agreement you can make right now?'],
        openPrayer:'Lord, let money be a tool in our hands, not a source of fear or division between us.',
        closePrayer:'Lord, help us to be faithful with what you give us and generous in how we hold it. Make us one in how we steward your provision.',
        flashCards:['Were you raised in a home that was careful or loose with money?','Are you a spender or a saver by instinct?','What does financial security feel like to you?','What does debt mean to you — neutral, shameful, or just practical?','What money habit do you have that you know could create tension?','What financial goal matters most to you in the next 5 years?','How should giving and generosity fit into how you manage money together?','What is one financial agreement you want to make today?']
      }
    ]
  },
  {
    key:'career', name:'Career & Calling', emoji:'🌟', desc:'Supporting each other\'s ambitions and navigating calling together.',
    sessions:[
      { id:'ca1', title:'Supporting Each Other\'s Calling', sub:'What your ambitions are and how you plan to champion each other.',
        why:`Two whole people with individual callings and ambitions don't stop having those when they enter a relationship. The question is how two strong callings coexist, support each other, and sometimes yield to each other without resentment.\n\nThis session helps you articulate what your career and calling means to you individually, and what it looks like to truly champion the person you love.`,
        scripture:{text:'Whatever you do, work heartily, as for the Lord and not for men.',ref:'Colossians 3:23'},
        myStory:['What do you believe you\'re called to do — and how central is that to your sense of identity?','What does success in your career or calling look like to you in 5–10 years?','What do you need from your partner when your work is demanding or your calling feels unclear?'],
        yourStory:['What does your partner believe they are called to?','What sacrifice have you already seen them make for their calling — and how do you feel about that?','What support would your partner need from you that you haven\'t fully committed to yet?'],
        middle:['Where do your callings and careers complement each other?','Where might they create tension?','What has gone unspoken about career and calling that needs to be said?','What principle should govern how you prioritise between career and relationship when they conflict?','What specific commitment can you make to champion each other\'s calling?'],
        openPrayer:'Lord, help us to see each other\'s callings as sacred and worthy of support.',
        closePrayer:'Lord, help us to build lives where both of us can flourish — in our calling and in our love.',
        flashCards:['What do you believe you\'re called to do with your life?','How central is your career to your sense of who you are?','What would it look like for you to feel fully supported in your calling?','Where might your callings create friction with each other?','What career sacrifice are you willing to make for this relationship?','What sacrifice would be too much — a real limit?','How should you handle seasons where one person\'s calling demands more?','What does "championing each other" look like in practice?']
      }
    ]
  },
  {
    key:'family', name:'Family & Roles', emoji:'🏡', desc:'How you will structure your home, raise children, and navigate extended family.',
    sessions:[
      { id:'fam1', title:'How We\'ll Do Family', sub:'Roles at home, children, parenting philosophy, and extended family.',
        why:`One of the most loaded conversations a couple can have is about family — because it touches everything: roles in the home, whether and when to have children, how to parent, what relationship you'll have with in-laws.\n\nPeople rarely discover their actual convictions on these questions until they're inside them. This session creates a structured space to surface them early, before they become conflict driven by unmet expectations.`,
        scripture:{text:'Train up a child in the way he should go; even when he is old he will not depart from it.',ref:'Proverbs 22:6'},
        myStory:['What roles did the men and women in your family play — and how have those shaped your expectations?','What is your honest position on having children — timing, number, and the fears that come with that?','How close are you to your family of origin, and what role do you want them to play in your marriage?'],
        yourStory:['What domestic roles and expectations do you sense your partner carries from their upbringing?','What is your partner\'s position on children — and how aligned is that with yours?','How does your partner relate to their family — and what impact might that have on your relationship?'],
        middle:['Where are your expectations about family roles most similar?','Where do they most significantly differ?','What extended family dynamic might create friction if not addressed?','What principle should guide how you make decisions about family?','What are two specific agreements you can make about family that give you both clarity?'],
        openPrayer:'Lord, help us to honour both families we come from while building a new one that belongs to you.',
        closePrayer:'Lord, give us wisdom to build a home that is full of love, structure, and your presence.',
        flashCards:['What roles did men and women play in your home growing up?','Do you want children — and when?','What kind of parent do you want to be?','How close do you want to be to your extended family?','What in-law dynamic are you already anticipating managing?','What does "family first" mean to you in practical terms?','What parenting style do you imagine and where does it come from?','What is one family expectation you\'ve never said out loud until now?']
      }
    ]
  },
  {
    key:'intimacy', name:'Intimacy & Expectations', emoji:'🤝', desc:'Emotional closeness, physical expectations, and the vulnerability for real oneness.',
    sessions:[
      { id:'i1', title:'Expectations We Brought In', sub:'The unspoken expectations about emotional and physical closeness you each carry.',
        why:`Every person enters a relationship with expectations — many of which they are not consciously aware of. Expectations about how often you'll talk, how affection will be expressed, what emotional availability looks like.\n\nThese expectations were formed by your upbringing, previous relationships, and your imagination of what this would feel like. When they go unspoken, they become invisible walls — and invisible walls cause real pain.`,
        scripture:{text:'Above all, keep loving one another earnestly, since love covers a multitude of sins.',ref:'1 Peter 4:8'},
        myStory:['What expectations about emotional closeness do you carry into this relationship?','What do you need physically and emotionally to feel loved and secure?','What expectation have you had that has already been disappointed — even slightly?'],
        yourStory:['What expectations about intimacy and closeness do you sense your partner holds?','What does your partner seem to need most in order to feel genuinely loved?','What expectation of theirs do you find most challenging to meet?'],
        middle:['Where are your intimacy needs and expectations most similar?','Where do they differ in ways that could create regular frustration?','What expectation have you been carrying silently that needs to be spoken today?','What principle should govern how you handle unmet expectations?','What commitment can you make about how you will keep expectations honest and open?'],
        openPrayer:'Lord, help us to be honest about what we need and gracious about what we receive.',
        closePrayer:'Lord, help us to love each other as we actually are — not as we imagined each other would be.',
        flashCards:['What do you need most to feel loved on an ordinary day?','What expectation did you bring into this relationship without realising it?','How do you prefer to receive affection?','What does emotional intimacy mean to you?','What leaves you feeling disconnected from your partner?','What does it feel like when you\'re fully known by someone?','What is an expectation you have that feels embarrassing to admit?','What would it take for you to feel deeply safe in this relationship?']
      }
    ]
  },
  {
    key:'vision', name:'Future Vision', emoji:'🔭', desc:'The life you are building together — where you\'re headed.',
    sessions:[
      { id:'v1', title:'The Life We\'re Building', sub:'Your shared picture of the future and what it will take to get there.',
        why:`Most couples think about the future in general terms. "I want a nice house." "I want to travel." These are vague pictures, and vague pictures don't navigate the hard choices of building a real life together.\n\nThis session asks you to paint a more specific picture — where will you live, what lifestyle will you build, what do you want your life to look like when you're sixty? Not to plan everything, but to discover whether your visions are pointing in the same direction.`,
        scripture:{text:'For I know the plans I have for you, declares the Lord, plans for welfare and not for evil, to give you a future and a hope.',ref:'Jeremiah 29:11'},
        myStory:['What does the life you\'re building together look like in your best imagination — in 5, 15, 30 years?','What location, lifestyle, and legacy matters most to you?','What is the one thing you absolutely do not want your future to look like?'],
        yourStory:['What does your partner\'s vision of the future look like?','Where does their vision excite you? Where does it create quiet anxiety?','What does your partner dream about that you haven\'t fully taken seriously yet?'],
        middle:['Where are your future visions most aligned?','Where do they diverge in potentially significant ways?','What decision is coming where you need clearer alignment?','What principle should govern how you make big decisions about direction?','What is the shared vision statement that captures where you\'re headed as a couple?'],
        openPrayer:'Lord, give us a shared vision that is bigger than either of us could have alone — and the courage to build toward it together.',
        closePrayer:'Lord, we commit our future to you. Lead us, correct us, and help us to build something worth building.',
        flashCards:['What does your ideal life look like in 10 years?','Where do you want to live — and how important is location to you?','What kind of lifestyle do you want? Quiet, busy, city, country?','What legacy do you want to leave?','What is one dream you have that you haven\'t said out loud to your partner yet?','Where do you think your visions for the future most differ?','What does "success" mean to you for your life as a whole?','What would need to be true for you to feel like you lived a good life?']
      }
    ]
  },
  {
    key:'friendship', name:'Friendship & Fun', emoji:'🎉', desc:'Making space for joy, laughter, and genuine friendship at the core of your love.',
    sessions:[
      { id:'fr1', title:'Friends Who Belong', sub:'Your social worlds, shared friendships, and making room for joy.',
        why:`The most enduring marriages are built on genuine friendship. Not just commitment — but a real, warm, alive friendship where two people genuinely enjoy each other, laugh together, and choose each other's company without obligation.\n\nThis session is lighter than most. But it is not unimportant. Couples who neglect to protect their joy often find they've built a productive but joyless partnership. Friendship needs maintenance. Play needs to be protected.`,
        scripture:{text:'A joyful heart is good medicine, but a crushed spirit dries up the bones.',ref:'Proverbs 17:22'},
        myStory:['What does fun look like to you — what genuinely fills you up and makes you come alive?','What role do friendships outside this relationship play in your life?','When do you feel most like friends with your partner?'],
        yourStory:['What makes your partner genuinely light up?','How does your partner relate to their friends, and what do those friendships mean to them?','What do you do together that brings out the best, most alive version of each of you?'],
        middle:['Where do your ideas of fun and rest align naturally?','Where do they differ — and how do you make space for both?','What friendship or social dynamic might need a conversation?','What principle should protect the joy and lightness in your relationship?','What is one specific thing you will commit to doing together regularly — just because it\'s fun?'],
        openPrayer:'Lord, help us never to lose the joy of each other. Protect the lightness and laughter you gave us.',
        closePrayer:'Lord, thank you for the gift of genuine friendship in this relationship. Help us never to take it for granted.',
        flashCards:['What is your idea of a perfect day together?','What makes you laugh the hardest?','What do you do that makes you feel most like yourself?','What is something fun you\'ve always wanted to try but haven\'t?','How do you like to recharge — alone or with people?','What friendship outside this relationship is important for you to keep?','What does it mean to be your partner\'s best friend?','What is one thing we should start doing together regularly just for the joy of it?']
      }
    ]
  }
];

const STAGE_PATHS = {
  dating:  ['foundation','faith','communication','conflict','vision'],
  engaged: ['faith','family','money','intimacy','communication'],
  married: ['communication','conflict','money','career','vision']
};

const STAGE_LABELS = {
  dating: '🌱 Dating / Courtship',
  engaged: '💍 Engaged',
  married: '🕊️ Married'
};

const SEC_NAMES = {
  openPrayer:'Opening Prayer', whyMatters:'Why This Matters',
  myStory:'My Story', yourStory:'Your Story',
  middle:'Find Our Middle', declaration:'Our Declaration',
  closePrayer:'Closing Prayer'
};

// ══════════════════════════════════════════════════════════
//  SCREEN MANAGEMENT
// ══════════════════════════════════════════════════════════
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('screen-'+name).classList.add('active');
  window.scrollTo(0,0);
  // Run screen-specific hooks inline (no recursive override)
  if(name==='couple') buildCoupleScreen();
  if(name==='profile') buildProfileScreen();
}

// ══════════════════════════════════════════════════════════
//  AUTH — V2 Magic Link / OTP (simulated)
// ══════════════════════════════════════════════════════════
function showAuthScreen(mode) {
  document.getElementById('auth-h2').textContent = mode==='signup'?'Create your account.':'Welcome back.';
  document.getElementById('auth-sub').textContent = mode==='signup'
    ?'Enter your email to get started — no password needed.'
    :'Enter your email to sign in — no password needed. We\'ll send you a 6-digit code.';
  showScreen('auth');
}

function sendOTP() {
  const email = document.getElementById('auth-email-input').value.trim();
  if(!email||!email.includes('@')) { alert('Please enter a valid email address.'); return; }
  S._pendingEmail = email;
  document.getElementById('otp-email-shown').textContent = email;
  // In real product: send OTP via API. Here we simulate with code 123456
  S._otpCode = '123456';
  showScreen('otp');
  setTimeout(()=>document.getElementById('otp-0').focus(), 200);
}

function otpInput(idx) {
  const val = document.getElementById('otp-'+idx).value;
  if(val && idx < 5) {
    document.getElementById('otp-'+(idx+1)).focus();
  }
}

function otpKey(e, idx) {
  if(e.key==='Backspace' && !document.getElementById('otp-'+idx).value && idx>0) {
    document.getElementById('otp-'+(idx-1)).focus();
  }
  if(e.key==='Enter') verifyOTP();
}

function verifyOTP() {
  const code = [0,1,2,3,4,5].map(i=>document.getElementById('otp-'+i).value).join('');
  if(code.length < 6) { alert('Please enter the full 6-digit code.'); return; }
  // In real product: verify against server. Here, code 123456 always works.
  if(code === '123456') {
    completeLogin(S._pendingEmail);
  } else {
    alert('Invalid code. (Demo: use 123456)');
  }
}

function completeLogin(email) {
  S.email = email;
  const name = email.split('@')[0];
  S.userName = name.charAt(0).toUpperCase()+name.slice(1);
  persistState();
  updateNavUserUI();
  if(S.stage) enterLibrary();
  else showScreen('stage');
}

function saveEmailFromZero() {
  const email = document.getElementById('zero-email').value.trim();
  if(!email||!email.includes('@')) { alert('Please enter a valid email.'); return; }
  S.email = email;
  const name = email.split('@')[0];
  S.userName = name.charAt(0).toUpperCase()+name.slice(1);
  persistState();
  updateNavUserUI();
  document.getElementById('zero-email-capture').style.display='none';
  document.getElementById('zero-library-btn').style.display='block';
}

function skipZeroEmail() {
  S.emailCaptureShown = Math.max(S.emailCaptureShown, 1);
  localStorage.setItem('oa_ecshown', S.emailCaptureShown);
  document.getElementById('zero-email-capture').style.display='none';
  document.getElementById('zero-library-btn').style.display='block';
}

function saveEmailFromConfirm() {
  const email = document.getElementById('confirm-email-input').value.trim();
  if(!email||!email.includes('@')) { alert('Please enter a valid email.'); return; }
  S.email = email;
  const name = email.split('@')[0];
  S.userName = name.charAt(0).toUpperCase()+name.slice(1);
  persistState();
  updateNavUserUI();
  document.getElementById('confirm-email-capture').style.display='none';
}

function showEmailModal(moment) {
  document.getElementById('email-modal').classList.add('show');
  if(moment===2) {
    document.getElementById('modal-title').textContent = 'Your declaration has been written.';
    document.getElementById('modal-sub').textContent = 'Save it permanently — this is the first entry in your shared archive. Declarations for anonymous users are stored locally only and are lost on browser clear.';
    document.getElementById('modal-skip-btn').textContent = 'Skip — I understand I may lose this';
  }
}

function closeEmailModal() {
  document.getElementById('email-modal').classList.remove('show');
}

function modalSaveEmail() {
  const email = document.getElementById('modal-email-input').value.trim();
  if(!email||!email.includes('@')) { alert('Please enter a valid email.'); return; }
  S.email = email;
  S.userName = email.split('@')[0];
  S.userName = S.userName.charAt(0).toUpperCase()+S.userName.slice(1);
  persistState();
  updateNavUserUI();
  closeEmailModal();
}

function updateNavUserUI() {
  const initial = S.userName ? S.userName.charAt(0).toUpperCase() : '?';
  // Library nav
  const libUser = document.getElementById('lib-nav-user');
  const libName = document.getElementById('lib-nav-name');
  const libInitial = document.getElementById('lib-nav-initial');
  const libPartner = document.getElementById('lib-partner-badge');
  const libPartnerName = document.getElementById('lib-partner-name');
  if(S.email) {
    if(libName) libName.textContent = S.userName||S.email;
    if(libInitial) libInitial.textContent = initial;
    if(libPartner && S.coupleSpaceId && S.partnerName) {
      libPartner.style.display='flex';
      libPartnerName.textContent = S.partnerName;
    }
  }
  // Stage nav
  const stageUser = document.getElementById('stage-nav-user');
  if(S.email && stageUser) {
    stageUser.style.display='flex';
    document.getElementById('stage-nav-name').textContent = S.userName||'';
    document.getElementById('stage-nav-initial').textContent = initial;
  }
  // Declarations / Progress nav initials
  ['decls-nav-initial','prog-nav-initial'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.textContent = initial;
  });
}

// ══════════════════════════════════════════════════════════
//  STAGE
// ══════════════════════════════════════════════════════════
function selectStage(stage,el) {
  S.stage = stage;
  document.querySelectorAll('.stage-card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  const btn = document.getElementById('stage-cta');
  btn.style.opacity='1'; btn.style.pointerEvents='auto';
}

function goToZero() {
  if(!S.stage) return;
  showScreen('zero');
}

// ══════════════════════════════════════════════════════════
//  SESSION ZERO
// ══════════════════════════════════════════════════════════
let zeroStep = 1;
function zeroNext(n) {
  document.getElementById('zs-'+zeroStep).classList.remove('active');
  zeroStep = n;
  document.getElementById('zs-'+n).classList.add('active');
  const dots = document.querySelectorAll('#zero-dots .pdot');
  dots.forEach((d,i)=>{
    d.classList.remove('active','done');
    if(i+1<n) d.classList.add('done');
    if(i+1===n) d.classList.add('active');
  });

  // Auto-generate zero declaration on step 4
  if(n===4) {
    const q1 = document.getElementById('zero-q1').value.trim();
    const q2 = document.getElementById('zero-q2').value.trim();
    let declText;
    if(q1||q2) {
      declText = `"We agree that this relationship should be defined by ${q1?q1.substring(0,60)+'...':'faithfulness, honesty, and choosing each other every day.'}"`;
    } else {
      declText = '"We agree that this relationship should be defined by faith, honesty, and the willingness to always choose each other — even when it\'s hard."';
    }
    document.getElementById('zero-decl-text').textContent = declText;

    // Show email capture only if not already logged in and not already shown
    if(S.email) {
      document.getElementById('zero-email-capture').style.display='none';
      document.getElementById('zero-library-btn').style.display='block';
    } else if(S.emailCaptureShown >= 1) {
      document.getElementById('zero-email-capture').style.display='none';
      document.getElementById('zero-library-btn').style.display='block';
    }
  }
  window.scrollTo(0,0);
}

function enterLibrary() {
  buildLibrary();
  showScreen('library');
}

// ══════════════════════════════════════════════════════════
//  LIBRARY — V2
// ══════════════════════════════════════════════════════════
function getSessionStatus(sessId) {
  // Returns: 'not_started' | 'in_progress' | 'awaiting_partner' | 'completed'
  const attempts = S.attempts.filter(a=>a.sessionId===sessId);
  const completed = attempts.find(a=>a.status==='completed');
  if(completed) return 'completed';
  const inProg = attempts.find(a=>a.status==='in_progress');
  if(inProg) {
    if(S.coupleSpaceId) return 'awaiting_partner';
    return 'in_progress';
  }
  // Also check old completedSessions
  if(S.completedSessions[sessId]) return 'completed';
  return 'not_started';
}

function getSessionAttempts(sessId) {
  return S.attempts.filter(a=>a.sessionId===sessId && a.status==='completed');
}

function buildLibrary() {
  updateNavUserUI();
  document.getElementById('stage-pill').textContent = STAGE_LABELS[S.stage]||'💍 Engaged';

  // Couple sync UI
  const connectedBanner = document.getElementById('couple-connected-banner');
  const connectCta = document.getElementById('connect-partner-cta');
  if(S.coupleSpaceId && S.partnerName) {
    connectedBanner.style.display='flex';
    connectCta.style.display='none';
    document.getElementById('couple-banner-title').textContent = `Connected with ${S.partnerName}`;
  } else if(S.email) {
    connectedBanner.style.display='none';
    connectCta.style.display='flex';
  } else {
    connectedBanner.style.display='none';
    connectCta.style.display='none';
  }

  const pathKeys = STAGE_PATHS[S.stage]||STAGE_PATHS.engaged;
  const recEl = document.getElementById('rec-path');
  recEl.innerHTML='';
  pathKeys.forEach((k,i)=>{
    const cat=CATS.find(c=>c.key===k); if(!cat) return;
    const el=document.createElement('div'); el.className='rec-step';
    el.innerHTML=`<div class="rec-step-num">${i+1}</div><div class="rec-step-name">${cat.emoji} ${cat.name}</div>`;
    el.onclick=()=>openCat(k);
    recEl.appendChild(el);
  });

  const grid=document.getElementById('cat-grid');
  grid.innerHTML='';
  CATS.forEach(cat=>{
    const totalSessions=cat.sessions.length;
    const completedCount=cat.sessions.filter(s=>getSessionStatus(s.id)==='completed').length;
    const pct=totalSessions>0?Math.round((completedCount/totalSessions)*100):0;
    const isComplete=completedCount===totalSessions&&totalSessions>0;

    const el=document.createElement('div'); el.className='cat-card';
    el.innerHTML=`
      ${isComplete?'<div class="cat-complete-badge">✓ Complete</div>':''}
      <span class="cat-emoji">${cat.emoji}</span>
      <div class="cat-name">${cat.name}</div>
      <div class="cat-count">${cat.sessions.length} session${cat.sessions.length>1?'s':''} · ${completedCount} done</div>
      <div class="cat-progress-bar"><div class="cat-progress-fill" style="width:${pct}%"></div></div>`;
    el.onclick=()=>openCat(cat.key);
    grid.appendChild(el);
  });
}

// ══════════════════════════════════════════════════════════
//  PICKER — V2 with attempts history
// ══════════════════════════════════════════════════════════
function openCat(key) {
  S.cat=key; S.session=null; S.mode=null;
  const cat=CATS.find(c=>c.key===key);

  document.getElementById('pick-cat-label').textContent=cat.emoji+' '+cat.name;
  document.getElementById('pick-cat-name').textContent=cat.name;
  document.getElementById('pick-title').textContent='Choose a Session';
  document.getElementById('pick-desc').textContent=cat.desc;
  document.getElementById('attempts-panel-wrap').style.display='none';
  document.getElementById('attempts-panel-wrap').innerHTML='';

  const list=document.getElementById('sess-list');
  list.innerHTML='';
  cat.sessions.forEach(sess=>{
    const status=getSessionStatus(sess.id);
    const attempts=getSessionAttempts(sess.id);
    const el=document.createElement('div'); el.className='sess-item';

    let statusBadge='';
    if(status==='completed') statusBadge=`<span class="sess-status-badge status-completed">✓ Completed</span>`;
    else if(status==='in_progress') statusBadge=`<span class="sess-status-badge status-in-progress">In Progress</span>`;
    else if(status==='awaiting_partner') statusBadge=`<span class="sess-status-badge status-awaiting">⏳ Awaiting ${S.partnerName||'partner'}</span>`;

    let metaHtml='';
    if(status==='completed'||attempts.length) {
      const lastAttempt=attempts[attempts.length-1];
      metaHtml=`<div class="sess-item-meta">
        ${statusBadge}
        ${lastAttempt?`<span class="sess-attempts-link" onclick="event.stopPropagation();toggleAttempts('${sess.id}',this)">${attempts.length} attempt${attempts.length>1?'s':''}</span>`:''}
        <button class="sess-do-again" onclick="event.stopPropagation();selectSessionForDoAgain('${sess.id}','${cat.key}')">↩ Do Again</button>
      </div>`;
    } else {
      metaHtml=`<div class="sess-item-meta">${statusBadge||'<span class="sess-status-badge" style="background:var(--surface);color:var(--subtle);border:1px solid var(--border)">Not started</span>'}</div>`;
    }

    el.innerHTML=`
      <div class="sess-item-main">
        <div>
          <div class="sess-title">${sess.title}</div>
          <div class="sess-sub">${sess.sub}</div>
        </div>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M6 4l4 4-4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
      ${metaHtml}`;
    el.onclick=()=>{ S.session=sess; document.querySelectorAll('.sess-item').forEach(i=>i.classList.remove('selected')); el.classList.add('selected'); checkPicker(); showAttemptsPanelFor(sess.id); };
    list.appendChild(el);
  });

  document.getElementById('mode-deep').classList.remove('selected');
  document.getElementById('mode-flash').classList.remove('selected');
  const btn=document.getElementById('begin-btn');
  btn.style.opacity='0.35'; btn.style.pointerEvents='none';

  showScreen('picker');
}

function showAttemptsPanelFor(sessId) {
  const wrap=document.getElementById('attempts-panel-wrap');
  const attempts=getSessionAttempts(sessId);
  if(!attempts.length) { wrap.style.display='none'; wrap.innerHTML=''; return; }

  let itemsHtml=attempts.slice().reverse().map((a,i)=>`
    <div class="attempt-item" onclick="toggleAttemptDecl(this)">
      <div class="attempt-meta">
        <span class="attempt-date">${a.date}</span>
        <span class="attempt-stage-tag">${STAGE_LABELS[a.stage]||a.stage||''}</span>
        <span class="attempt-mode-tag">${a.mode==='flash'?'⚡ Flashcard':'📖 Deep'}</span>
        ${a.partners?`<span style="font-size:11px;color:#4a6b1a;background:var(--lime-bg);padding:2px 7px;border-radius:100px;">Couple Space</span>`:''}
      </div>
      <div class="attempt-decl">"${a.declaration}"</div>
    </div>`).join('');

  wrap.innerHTML=`<div class="attempts-panel">
    <div class="attempts-panel-header">📖 Previous Attempts (${attempts.length})</div>
    ${itemsHtml}
  </div>`;
  wrap.style.display='block';
}

function toggleAttemptDecl(el) {
  const decl=el.querySelector('.attempt-decl');
  decl.classList.toggle('expanded');
}

function toggleAttempts(sessId, linkEl) {
  // reuse showAttemptsPanelFor
  showAttemptsPanelFor(sessId);
}

function selectSessionForDoAgain(sessId, catKey) {
  S.cat=catKey;
  const cat=CATS.find(c=>c.key===catKey);
  const sess=cat.sessions.find(s=>s.id===sessId);
  S.session=sess;
  document.querySelectorAll('.sess-item').forEach(i=>i.classList.remove('selected'));
  openCat(catKey);
  // auto-select the session
  setTimeout(()=>{
    const items=document.querySelectorAll('.sess-item');
    items.forEach(item=>{
      if(item.querySelector('.sess-title')&&item.querySelector('.sess-title').textContent===sess.title) {
        item.classList.add('selected');
        S.session=sess;
        showAttemptsPanelFor(sessId);
      }
    });
    checkPicker();
  },50);
}

function selectMode(mode,el) {
  S.mode=mode;
  document.querySelectorAll('.mode-card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  checkPicker();
}

function checkPicker() {
  if(S.session&&S.mode) {
    const btn=document.getElementById('begin-btn');
    btn.style.opacity='1'; btn.style.pointerEvents='auto';
  }
}

// ══════════════════════════════════════════════════════════
//  BEGIN SESSION
// ══════════════════════════════════════════════════════════
function beginSession() {
  if(!S.session||!S.mode) return;
  if(S.mode==='flash') startFlash();
  else startDeep();
}

// ══════════════════════════════════════════════════════════
//  FLASHCARD SESSION — V2
// ══════════════════════════════════════════════════════════
function startFlash() {
  S.flashIdx=0; S.flashFlipped=false; S.flashDeclShowing=false;
  renderFlash();
  document.getElementById('flash-decl-section').style.display='none';
  document.getElementById('flash-decl-input').value='';
  showScreen('flash');
}

function renderFlash() {
  const cards=S.session.flashCards||[];
  const idx=S.flashIdx;
  const total=cards.length;

  const progEl=document.getElementById('flash-progress');
  progEl.innerHTML=cards.map((_,i)=>`<div class="fp-seg ${i<idx?'done':i===idx?'active':''}"></div>`).join('');
  document.getElementById('flash-counter').textContent=`Card ${idx+1} of ${total}`;

  S.flashFlipped=false;
  const fc=document.getElementById('flashcard');
  fc.classList.remove('flipped');

  document.getElementById('fc-question').textContent=cards[idx];
  document.getElementById('fc-prompt').textContent=cards[idx];

  const nextBtn=document.getElementById('flash-next-btn');
  if(idx===total-1) {
    nextBtn.className='flash-btn flash-btn-finish';
    nextBtn.textContent='Write Your Declaration ✓';
    nextBtn.onclick=showFlashDecl;
  } else {
    nextBtn.className='flash-btn flash-btn-next';
    nextBtn.textContent='Next Card →';
    nextBtn.onclick=flashNext;
  }
}

function flipCard() { S.flashFlipped=!S.flashFlipped; const fc=document.getElementById('flashcard'); fc.classList.toggle('flipped',S.flashFlipped); }
function flashNext() { if(S.flashIdx<(S.session.flashCards||[]).length-1){ S.flashIdx++; renderFlash(); } }
function flashPrev() { if(S.flashIdx>0){ S.flashIdx--; renderFlash(); } }

function showFlashDecl() {
  document.getElementById('flash-decl-section').style.display='block';
  document.getElementById('flash-decl-section').scrollIntoView({behavior:'smooth'});
}

function saveFlashDeclaration() {
  const txt=document.getElementById('flash-decl-input').value.trim();
  const full='We agree that '+(txt||'we chose to have this conversation and grow closer through it.');
  saveDeclaration(full);
}

// ══════════════════════════════════════════════════════════
//  DEEP SESSION — V2
// ══════════════════════════════════════════════════════════
function startDeep() {
  const sess=S.session;
  S.sections=[
    {type:'openPrayer',data:sess},
    {type:'whyMatters',data:sess},
    {type:'myStory',data:sess},
    {type:'yourStory',data:sess},
    {type:'middle',data:sess},
    {type:'declaration',data:sess},
    {type:'closePrayer',data:sess}
  ];
  S.secIdx=0;
  const cat=CATS.find(c=>c.key===S.cat);
  document.getElementById('sess-cat-label').textContent=cat.emoji+' '+cat.name+' · '+sess.title;
  renderSection(0);
  showScreen('session');
}

function renderSection(idx) {
  S.secIdx=idx;
  const secs=S.sections;
  const sec=secs[idx];
  const sess=sec.data;
  const isLast=idx===secs.length-1;

  const progEl=document.getElementById('sess-prog');
  progEl.innerHTML=secs.map((_,i)=>`<div class="sp-seg ${i<idx?'done':i===idx?'active':''}"></div>`).join('');
  document.getElementById('sess-step-label').textContent=`${SEC_NAMES[sec.type]} · ${idx+1}/${secs.length}`;

  const body=document.getElementById('sess-body');
  body.style.animation='none';
  void body.offsetWidth;
  body.style.animation='fadeUp 0.4s ease forwards';

  const navBtns=`
    <div class="sess-nav">
      ${idx>0?`<button class="btn-back-sess" onclick="renderSection(${idx-1})">← Back</button>`:'<span></span>'}
      ${isLast
        ?`<button class="btn-finish-sess" onclick="finishDeep()">Seal Declaration ✓</button>`
        :`<button class="btn-next-sess" onclick="renderSection(${idx+1})">Continue →</button>`
      }
    </div>`;

  // Couple sync notice for myStory/yourStory
  const coupleNote = S.coupleSpaceId&&S.partnerName ? {
    myStory:`<div class="couple-sync-notice"><strong>My Story is private.</strong> Your reflections here are visible only to you — never to ${S.partnerName}.</div>`,
    yourStory:`<div class="couple-sync-notice"><strong>Your Story</strong> answers will be shared with ${S.partnerName} once you submit this section.</div>`,
    declaration:`<div class="couple-sync-notice"><strong>Shared Declaration.</strong> ${S.partnerName} will see your draft and can contribute before you seal it together.</div>`
  } : {myStory:'',yourStory:'',declaration:''};

  let html='';
  switch(sec.type) {
    case 'openPrayer': case 'closePrayer': {
      const txt=sec.type==='openPrayer'?sess.openPrayer:sess.closePrayer;
      const lbl=sec.type==='openPrayer'?'Opening Prayer':'Closing Prayer';
      const subtitle=sec.type==='openPrayer'?'Before you begin.':'Before you close.';
      html=`<div class="sec-tag">${lbl}</div><h2 class="sec-title">${subtitle}</h2>
        <div class="prayer-block"><p class="prayer-text">"${txt}"</p><p class="prayer-cue">✦ Pray this together before continuing</p></div>
        ${navBtns}`;
      break;
    }
    case 'whyMatters': {
      const paras=sess.why.split('\n\n').filter(Boolean);
      html=`<div class="sec-tag">Why This Matters</div><h2 class="sec-title">${sess.title}</h2>
        ${paras.map(p=>`<p class="why-text">${p}</p>`).join('')}
        ${sess.scripture?`<div class="scripture-block"><p class="scripture-verse">"${sess.scripture.text}"</p><p class="scripture-ref">— ${sess.scripture.ref}</p></div>`:''}
        ${navBtns}`;
      break;
    }
    case 'myStory': {
      html=`<div class="sec-tag">My Story</div><h2 class="sec-title">Reflect individually,<br>then share.</h2>
        ${coupleNote.myStory}
        <div class="q-stack">
          ${sess.myStory.map((q,i)=>`
            <div class="q-block">
              <div class="q-num">Question ${i+1}</div>
              <div class="q-text">${q}</div>
              <textarea class="q-field" placeholder="Reflect here before sharing with your partner…"></textarea>
              ${S.email?`<label class="q-save-toggle"><input type="checkbox" checked> <span class="q-save-label">Save this reflection to my account</span></label>`:''}
            </div>`).join('')}
        </div>${navBtns}`;
      break;
    }
    case 'yourStory': {
      html=`<div class="sec-tag">Your Story</div><h2 class="sec-title">Now, understand<br>your partner.</h2>
        ${coupleNote.yourStory}
        <div class="q-stack">
          ${sess.yourStory.map((q,i)=>`
            <div class="q-block">
              <div class="q-num">Question ${i+1}</div>
              <div class="q-text">${q}</div>
              <textarea class="q-field" placeholder="What do you observe, know, or want to ask?"></textarea>
            </div>`).join('')}
        </div>${navBtns}`;
      break;
    }
    case 'middle': {
      html=`<div class="sec-tag">Find Our Middle</div><h2 class="sec-title">From two perspectives<br>to one conviction.</h2>
        <div class="middle-stack">
          ${sess.middle.map((p,i)=>`
            <div class="mid-item">
              <div class="mid-n">${i+1}</div>
              <div class="mid-content">
                <div class="mid-prompt">${p}</div>
                <textarea class="q-field" placeholder="Discuss and write your answer together…"></textarea>
              </div>
            </div>`).join('')}
        </div>${navBtns}`;
      break;
    }
    case 'declaration': {
      html=`<div class="sec-tag">Our Declaration</div><h2 class="sec-title">Write your<br>shared conviction.</h2>
        ${coupleNote.declaration}
        <p class="why-text" style="margin-bottom:0;">This is the most important part of every session. In your own words, write what you both agree on. This becomes part of your permanent shared archive.</p>
        <div class="decl-wrap">
          <span class="decl-preamble">We agree that...</span>
          <textarea class="decl-field" id="decl-input" placeholder="…write your declaration here, together, in your own words."></textarea>
          <p class="decl-hint">Take your time. Sealed declarations cannot be edited.</p>
        </div>${navBtns}`;
      break;
    }
  }

  body.innerHTML=html;
  window.scrollTo(0,0);
}

function finishDeep() {
  const inp=document.getElementById('decl-input');
  const txt=inp?inp.value.trim():'';
  const full='We agree that '+(txt||'…');
  saveDeclaration(full);
}

// ══════════════════════════════════════════════════════════
//  SAVE DECLARATION — V2 Attempt Model
// ══════════════════════════════════════════════════════════
function saveDeclaration(text) {
  const cat=CATS.find(c=>c.key===S.cat);
  const now=new Date();
  const dateStr=now.toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'});

  // Create attempt record
  const attempt = {
    id: Date.now(),
    sessionId: S.session?S.session.id:'',
    sessionTitle: S.session?S.session.title:'',
    category: cat?cat.name:'',
    categoryEmoji: cat?cat.emoji:'',
    mode: S.mode||'deep',
    stage: S.stage||'',
    status: 'completed',
    declaration: text,
    date: dateStr,
    dateMs: now.getTime(),
    partners: S.coupleSpaceId ? [S.userName||S.email, S.partnerName||S.partnerEmail] : null
  };
  S.attempts.push(attempt);

  // Also keep in old declarations for backwards compat
  const rec={
    id:Date.now(),
    category:cat?cat.name:'',
    emoji:cat?cat.emoji:'',
    session:S.session?S.session.title:'',
    text,
    date:dateStr,
    stage:S.stage||'',
    attemptNum: S.attempts.filter(a=>a.sessionId===attempt.sessionId).length,
    partners: attempt.partners
  };
  S.declarations.unshift(rec);

  // Mark session completed
  if(S.session) S.completedSessions[S.session.id]=true;

  persistState();

  // Show confirm screen
  document.getElementById('confirm-text').textContent=text;

  // Show email capture if not logged in (moment 2)
  const captureEl=document.getElementById('confirm-email-capture');
  if(!S.email && S.emailCaptureShown < 2) {
    captureEl.style.display='block';
    S.emailCaptureShown=2;
    localStorage.setItem('oa_ecshown','2');
  } else {
    captureEl.style.display='none';
  }

  showScreen('confirm');
}

// ══════════════════════════════════════════════════════════
//  LIB TABS — V2
// ══════════════════════════════════════════════════════════
function showLibTab(tab) {
  if(tab==='library') { buildLibrary(); showScreen('library'); }
  else if(tab==='declarations') { renderDecls(); showScreen('declarations'); }
  else if(tab==='progress') { renderProgress(); showScreen('progress'); }
}

function renderDecls() {
  updateNavUserUI();
  const el=document.getElementById('decls-list');
  if(!S.declarations.length) {
    el.innerHTML=`<div class="empty-decls"><div class="empty-decls-title">No declarations yet.</div><div class="empty-decls-sub">Complete your first session to see your declarations here.</div></div>`;
    return;
  }
  el.innerHTML=S.declarations.map(d=>`
    <div class="decl-item">
      <div class="di-cat">${d.emoji} ${d.category}</div>
      <div class="di-title">${d.session}</div>
      <div class="di-text">"${d.text}"</div>
      <div class="di-footer">
        <span class="di-date">${d.date}</span>
        ${d.stage?`<span class="di-stage-tag">${STAGE_LABELS[d.stage]||d.stage}</span>`:''}
        ${d.attemptNum>1?`<span class="di-attempt-num">Attempt #${d.attemptNum}</span>`:''}
        ${d.partners?`<span class="di-partners">🔗 ${d.partners.join(' & ')}</span>`:''}
      </div>
    </div>`).join('');
}

// ══════════════════════════════════════════════════════════
//  PROGRESS — V2
// ══════════════════════════════════════════════════════════
function renderProgress() {
  updateNavUserUI();
  const totalSessions=CATS.reduce((acc,c)=>acc+c.sessions.length,0);
  const completedCount=Object.keys(S.completedSessions).filter(k=>S.completedSessions[k]).length;
  const totalDeclarations=S.declarations.length;
  const totalAttempts=S.attempts.filter(a=>a.status==='completed').length;

  const catGridHtml=CATS.map(cat=>{
    const total=cat.sessions.length;
    const done=cat.sessions.filter(s=>S.completedSessions[s.id]).length;
    const pct=total>0?Math.round((done/total)*100):0;
    return `<div class="prog-cat-item">
      <span class="pci-emoji">${cat.emoji}</span>
      <div class="pci-name">${cat.name}</div>
      <div class="pci-count">${done}/${total} sessions</div>
      <div class="pci-bar"><div class="pci-bar-fill" style="width:${pct}%"></div></div>
      ${done===total&&total>0?`<div class="pci-complete">✓ Complete</div>`:''}
    </div>`;
  }).join('');

  const completedAttempts=S.attempts.filter(a=>a.status==='completed').slice().reverse();
  const timelineHtml=completedAttempts.length
    ?completedAttempts.map(a=>`
      <div class="timeline-item">
        <div class="timeline-item-icon">${CATS.find(c=>c.key===S.cat&&c.sessions.find(s=>s.id===a.sessionId))?CATS.find(c=>c.sessions.find(s=>s.id===a.sessionId))?.emoji||'📖':'📖'}</div>
        <div class="timeline-item-body">
          <div class="timeline-item-title">${a.sessionTitle}</div>
          <div class="timeline-item-sub">${a.category} · ${a.mode==='flash'?'⚡ Flashcard':'📖 Deep'}</div>
        </div>
        <div class="timeline-item-date">${a.date}</div>
      </div>`).join('')
    :`<div style="padding:32px;text-align:center;color:var(--muted);font-size:14px;">Complete your first session to see your timeline.</div>`;

  document.getElementById('progress-wrap').innerHTML=`
    <div class="lib-top" style="margin-bottom:28px">
      <h2 style="font-size:24px;font-weight:800;letter-spacing:-0.5px;">Your Progress</h2>
    </div>
    <div class="progress-hero">
      <div class="ph-stat">
        <div class="ph-num">${completedCount}</div>
        <div class="ph-label">Sessions Completed</div>
      </div>
      <div class="ph-stat">
        <div class="ph-num">${totalDeclarations}</div>
        <div class="ph-label">Declarations Sealed</div>
      </div>
      <div class="ph-stat">
        <div class="ph-num">${totalAttempts}</div>
        <div class="ph-label">Total Attempts</div>
      </div>
    </div>

    <div class="progress-section-title">Category Overview</div>
    <div class="prog-cat-grid">${catGridHtml}</div>

    <div class="progress-section-title">Session Timeline</div>
    <div class="timeline-list">${timelineHtml}</div>
  `;
}

// ══════════════════════════════════════════════════════════
//  COUPLE SYNC — V2
// ══════════════════════════════════════════════════════════
function buildCoupleScreen() {
  const content=document.getElementById('couple-content');
  const enterCodeSection=document.getElementById('enter-code-section');

  if(!S.email) {
    content.innerHTML=`
      <div style="background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:28px;text-align:center;margin-bottom:20px;">
        <div style="font-size:32px;margin-bottom:12px;">🔐</div>
        <div style="font-size:16px;font-weight:700;margin-bottom:8px;">Sign in first</div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:20px;">Couple Sync requires an account so each partner has their own verified identity.</div>
        <button class="btn-dark" onclick="showAuthScreen('signup')">Create Account →</button>
      </div>`;
    enterCodeSection.style.display='none';
    return;
  }

  if(S.coupleSpaceId && S.partnerName) {
    // Connected state
    content.innerHTML=`
      <div class="partner-list" style="margin-top:0;width:100%">
        <div class="partner-row">
          <div class="partner-avatar">${(S.userName||'Y').charAt(0).toUpperCase()}</div>
          <div class="partner-info">
            <div class="partner-name">${S.userName||S.email} (you)</div>
            <div class="partner-email">${S.email}</div>
          </div>
          <span class="partner-status-tag status-completed">✓ Connected</span>
        </div>
        <div class="partner-row">
          <div class="partner-avatar partner-b">${(S.partnerName||'P').charAt(0).toUpperCase()}</div>
          <div class="partner-info">
            <div class="partner-name">${S.partnerName}</div>
            <div class="partner-email">${S.partnerEmail}</div>
          </div>
          <span class="partner-status-tag status-completed">✓ Connected</span>
        </div>
      </div>
      <div style="margin-top:24px;width:100%;text-align:center;">
        <button class="profile-danger-btn" onclick="disconnectCouple()" style="font-size:14px;padding:10px 20px;">Disconnect Couple Space</button>
      </div>`;
    enterCodeSection.style.display='none';
  } else {
    // Generate invite code
    if(!S._generatedCode) {
      S._generatedCode = Math.random().toString(36).substr(2,6).toUpperCase();
    }
    content.innerHTML=`
      <div class="invite-code-box">
        <div class="invite-code-label">Your Invite Code</div>
        <div class="invite-code">${S._generatedCode}</div>
        <div class="invite-code-expiry">Expires in 48 hours</div>
        <button class="invite-copy-btn" onclick="copyInviteCode()">Copy Code</button>
      </div>
      <p style="font-size:13px;color:var(--muted);text-align:center;margin-bottom:8px;">Share this code with your partner. They enter it below to link your accounts.</p>
    `;
    enterCodeSection.style.display='block';
  }
}

function copyInviteCode() {
  navigator.clipboard.writeText(S._generatedCode||'').then(()=>{
    const btn=document.querySelector('.invite-copy-btn');
    if(btn){ btn.textContent='Copied! ✓'; setTimeout(()=>btn.textContent='Copy Code',2000); }
  });
}

function acceptInviteCode() {
  const code=document.getElementById('enter-code-input').value.trim().toUpperCase();
  if(code.length<4){ alert('Please enter a valid invite code.'); return; }

  // Simulate accepting — in real product this would call the API
  // We'll pretend the code matches and create a fake partner
  const partnerEmail=prompt('Enter your partner\'s email (or we\'ll simulate it):','partner@example.com');
  if(!partnerEmail) return;

  S.coupleSpaceId = 'cs_'+Date.now();
  S.partnerEmail = partnerEmail;
  S.partnerName = partnerEmail.split('@')[0];
  S.partnerName = S.partnerName.charAt(0).toUpperCase()+S.partnerName.slice(1);
  persistState();
  updateNavUserUI();
  buildCoupleScreen();
  alert(`✓ Couple Space created! You're now connected with ${S.partnerName}.`);
}

function disconnectCouple() {
  if(!confirm('Disconnect your Couple Space? Your individual declarations are preserved.')) return;
  S.coupleSpaceId=null; S.partnerEmail=null; S.partnerName=null;
  localStorage.removeItem('oa_couple_space');
  localStorage.removeItem('oa_partner_email');
  localStorage.removeItem('oa_partner_name');
  persistState();
  updateNavUserUI();
  buildCoupleScreen();
}

// ══════════════════════════════════════════════════════════
//  PROFILE — V2
// ══════════════════════════════════════════════════════════
function buildProfileScreen() {
  const wrap=document.getElementById('profile-wrap');
  const completedCount=Object.keys(S.completedSessions).filter(k=>S.completedSessions[k]).length;

  wrap.innerHTML=`
    <div style="margin-bottom:28px">
      <div style="width:64px;height:64px;border-radius:50%;background:var(--ink);color:#fff;font-size:24px;font-weight:700;display:flex;align-items:center;justify-content:center;margin-bottom:16px;">
        ${S.userName?S.userName.charAt(0).toUpperCase():'?'}
      </div>
      <div style="font-size:24px;font-weight:800;letter-spacing:-0.5px;">${S.userName||'Anonymous'}</div>
      <div style="font-size:14px;color:var(--muted);margin-top:2px;">${S.email||'Not signed in'}</div>
    </div>

    <div class="profile-card">
      <div class="profile-section-title">Account</div>
      <div class="profile-row">
        <div class="profile-row-label">Email</div>
        <div class="profile-row-value">${S.email||'—'}</div>
      </div>
      <div class="profile-row">
        <div class="profile-row-label">Relationship Stage</div>
        <div class="profile-row-value">${STAGE_LABELS[S.stage]||'Not set'}</div>
        <button class="profile-action-btn" onclick="showScreen('stage')">Change</button>
      </div>
      ${!S.email?`<div class="profile-row"><button class="btn-dark" onclick="showAuthScreen('signup')" style="padding:10px 20px;font-size:14px">Create Account →</button></div>`:''}
    </div>

    <div class="profile-card">
      <div class="profile-section-title">Couple Space</div>
      <div class="profile-row">
        <div class="profile-row-label">Partner</div>
        <div class="profile-row-value">${S.partnerName||'Not connected'}</div>
        <button class="profile-action-btn" onclick="showScreen('couple');buildCoupleScreen()">${S.coupleSpaceId?'Manage':'Connect'}</button>
      </div>
    </div>

    <div class="profile-card">
      <div class="profile-section-title">Progress</div>
      <div class="profile-row">
        <div class="profile-row-label">Sessions completed</div>
        <div class="profile-row-value">${completedCount} of ${CATS.reduce((a,c)=>a+c.sessions.length,0)}</div>
      </div>
      <div class="profile-row">
        <div class="profile-row-label">Declarations sealed</div>
        <div class="profile-row-value">${S.declarations.length}</div>
      </div>
    </div>

    <div class="profile-card">
      <div class="profile-section-title">Notifications</div>
      <div class="profile-row">
        <div class="profile-row-label">Partner completion emails</div>
        <div class="profile-row-value">On</div>
        <button class="profile-action-btn">Toggle</button>
      </div>
    </div>

    ${S.email?`<button class="profile-danger-btn" style="margin-top:8px;font-size:14px;padding:10px 20px;border-radius:9px;width:100%;" onclick="signOut()">Sign out</button>`:''}
  `;
}

function signOut() {
  if(!confirm('Sign out? Your progress is saved and will be here when you return.')) return;
  S.email=null; S.userName=null;
  localStorage.removeItem('oa_email'); localStorage.removeItem('oa_name');
  enterLibrary();
}

// ══════════════════════════════════════════════════════════
//  INIT
// ══════════════════════════════════════════════════════════
updateNavUserUI();
buildLibrary();
</script>
</body>
</html>
